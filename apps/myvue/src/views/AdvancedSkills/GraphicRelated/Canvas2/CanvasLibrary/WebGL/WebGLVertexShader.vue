<template>
  <div class="vertex-shader-container">
    <!-- æ ‡é¢˜å’Œæ¦‚è¿°éƒ¨åˆ† -->
    <header>
      <h1>WebGL é¡¶ç‚¹ç€è‰²å™¨åŸºç¡€ä»‹ç»</h1>
      <p class="overview">
        é¡¶ç‚¹ç€è‰²å™¨æ˜¯WebGLæ¸²æŸ“ç®¡çº¿çš„ç¬¬ä¸€ä¸ªå¯ç¼–ç¨‹é˜¶æ®µï¼Œè´Ÿè´£å¤„ç†é¡¶ç‚¹æ•°æ®å¹¶ç¡®å®šé¡¶ç‚¹åœ¨å±å¹•ä¸Šçš„æœ€ç»ˆä½ç½®ã€‚
        å®ƒæ˜¯æ„å»ºå¤æ‚3Då›¾å½¢çš„åŸºçŸ³ï¼Œä¹Ÿæ˜¯å®ç°å‡ ä½•å˜æ¢å’Œé¡¶ç‚¹åŠ¨ç”»çš„å…³é”®ç»„ä»¶ã€‚
      </p>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="content-wrapper">
      <!-- å·¦ä¾§å¯¼èˆª -->
      <nav class="navigation">
        <div v-for="(item, index) in navItems" :key="index" :class="{ active: activeSection === index }"
          @click="activeSection = index">
          {{ item.title }}
        </div>
      </nav>

      <!-- å³ä¾§å†…å®¹ -->
      <div class="content">
        <!-- åŸºç¡€æ¦‚å¿µéƒ¨åˆ† -->
        <section v-show="activeSection === 0">
          <h2>é¡¶ç‚¹ç€è‰²å™¨åŸºç¡€æ¦‚å¿µ</h2>

          <div class="card">
            <h3>ä»€ä¹ˆæ˜¯é¡¶ç‚¹ç€è‰²å™¨ï¼Ÿ</h3>
            <p>
              é¡¶ç‚¹ç€è‰²å™¨æ˜¯WebGLæ¸²æŸ“ç®¡çº¿ä¸­çš„ç¬¬ä¸€ä¸ªå¯ç¼–ç¨‹é˜¶æ®µï¼Œè´Ÿè´£å¤„ç†æ¯ä¸ªé¡¶ç‚¹çš„å±æ€§æ•°æ®ã€‚
              å®ƒæ¥æ”¶é¡¶ç‚¹åæ ‡ã€é¢œè‰²ã€çº¹ç†åæ ‡ç­‰å±æ€§ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡ºæ¯ä¸ªé¡¶ç‚¹åœ¨è£å‰ªç©ºé—´ä¸­çš„ä½ç½®ã€‚
            </p>

            <div class="illustration">
              <div class="pipeline">
                <div class="stage">é¡¶ç‚¹æ•°æ®</div>
                <div class="arrow">â†’</div>
                <div class="stage highlight">é¡¶ç‚¹ç€è‰²å™¨</div>
                <div class="arrow">â†’</div>
                <div class="stage">å›¾å…ƒè£…é…</div>
                <div class="arrow">â†’</div>
                <div class="stage">å…‰æ …åŒ–</div>
                <div class="arrow">â†’</div>
                <div class="stage">ç‰‡æ®µç€è‰²å™¨</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>é¡¶ç‚¹ç€è‰²å™¨çš„æ ¸å¿ƒåŠŸèƒ½</h3>
            <div class="features-grid">
              <div class="feature">
                <div class="icon">ğŸ“</div>
                <h4>é¡¶ç‚¹å˜æ¢</h4>
                <p>å°†æ¨¡å‹åæ ‡å˜æ¢åˆ°è£å‰ªç©ºé—´åæ ‡</p>
              </div>
              <div class="feature">
                <div class="icon">ğŸ¨</div>
                <h4>é¡¶ç‚¹å±æ€§è®¡ç®—</h4>
                <p>è®¡ç®—æ¯ä¸ªé¡¶ç‚¹çš„é¢œè‰²ã€çº¹ç†åæ ‡ç­‰</p>
              </div>
              <div class="feature">
                <div class="icon">ğŸŒ€</div>
                <h4>å‡ ä½•å˜å½¢</h4>
                <p>å®ç°é¡¶ç‚¹åŠ¨ç”»å’Œå½¢çŠ¶å˜æ¢</p>
              </div>
              <div class="feature">
                <div class="icon">ğŸ“</div>
                <h4>å…‰ç…§è®¡ç®—</h4>
                <p>ä¸ºé¡¶ç‚¹è®¡ç®—å…‰ç…§æ•ˆæœï¼ˆGouraudç€è‰²ï¼‰</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>é¡¶ç‚¹ç€è‰²å™¨è¾“å…¥/è¾“å‡º</h3>
            <div class="io-table">
              <table>
                <thead>
                  <tr>
                    <th>ç±»å‹</th>
                    <th>å˜é‡</th>
                    <th>æè¿°</th>
                    <th>ç¤ºä¾‹</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td rowspan="3">è¾“å…¥</td>
                    <td>attribute</td>
                    <td>é¡¶ç‚¹å±æ€§ï¼ˆä½ç½®ã€é¢œè‰²ã€æ³•çº¿ç­‰ï¼‰</td>
                    <td>attribute vec3 aPosition;</td>
                  </tr>
                  <tr>
                    <td>uniform</td>
                    <td>å…¨å±€å¸¸é‡ï¼ˆçŸ©é˜µã€æ—¶é—´ç­‰ï¼‰</td>
                    <td>uniform mat4 uModelViewMatrix;</td>
                  </tr>
                  <tr>
                    <td>varying</td>
                    <td>ä¼ é€’ç»™ç‰‡æ®µç€è‰²å™¨çš„å˜é‡</td>
                    <td>varying vec4 vColor;</td>
                  </tr>
                  <tr>
                    <td>è¾“å‡º</td>
                    <td>gl_Position</td>
                    <td>é¡¶ç‚¹åœ¨è£å‰ªç©ºé—´çš„ä½ç½®</td>
                    <td>gl_Position = projection * position;</td>
                  </tr>
                  <tr>
                    <td>è¾“å‡º</td>
                    <td>gl_PointSize</td>
                    <td>ç‚¹ç²¾çµçš„å¤§å°ï¼ˆå¯é€‰ï¼‰</td>
                    <td>gl_PointSize = 10.0;</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ä»£ç å®ç°éƒ¨åˆ† -->
        <section v-show="activeSection === 1">
          <h2>é¡¶ç‚¹ç€è‰²å™¨ä»£ç å®ç°</h2>

          <div class="card">
            <h3>åŸºç¡€é¡¶ç‚¹ç€è‰²å™¨ç¤ºä¾‹</h3>
            <div class="code-sample">
              <pre><code>// é¡¶ç‚¹å±æ€§ï¼šä½ç½®
attribute vec3 aPosition;

// ç»Ÿä¸€å˜é‡ï¼šæ¨¡å‹è§†å›¾æŠ•å½±çŸ©é˜µ
uniform mat4 uModelViewProjectionMatrix;

void main() {
  // å°†é¡¶ç‚¹ä½ç½®ä¹˜ä»¥æ¨¡å‹è§†å›¾æŠ•å½±çŸ©é˜µ
  gl_Position = uModelViewProjectionMatrix * vec4(aPosition, 1.0);

  // è®¾ç½®ç‚¹ç²¾çµå¤§å°ï¼ˆå¯é€‰ï¼‰
  gl_PointSize = 5.0;
}</code></pre>
            </div>

            <div class="explanation">
              <h4>ä»£ç è§£æï¼š</h4>
              <ul>
                <li><strong>attribute</strong>ï¼šå£°æ˜é¡¶ç‚¹å±æ€§ï¼Œæ¯ä¸ªé¡¶ç‚¹æœ‰ç‹¬ç«‹çš„å€¼</li>
                <li><strong>uniform</strong>ï¼šå£°æ˜å…¨å±€ç»Ÿä¸€å˜é‡ï¼Œæ‰€æœ‰é¡¶ç‚¹å…±äº«ç›¸åŒçš„å€¼</li>
                <li><strong>gl_Position</strong>ï¼šå¿…é¡»èµ‹å€¼çš„è¾“å‡ºå˜é‡ï¼Œè¡¨ç¤ºé¡¶ç‚¹åœ¨è£å‰ªç©ºé—´çš„ä½ç½®</li>
                <li><strong>gl_PointSize</strong>ï¼šå¯é€‰çš„è¾“å‡ºå˜é‡ï¼Œå®šä¹‰ç‚¹ç²¾çµçš„å¤§å°</li>
              </ul>
            </div>
          </div>

          <div class="card">
            <h3>ä¼ é€’æ•°æ®ç»™ç‰‡æ®µç€è‰²å™¨</h3>
            <div class="code-sample">
              <pre><code>// é¡¶ç‚¹å±æ€§
attribute vec3 aPosition;
attribute vec3 aColor;

// ç»Ÿä¸€å˜é‡
uniform mat4 uModelViewProjectionMatrix;

// ä¼ é€’ç»™ç‰‡æ®µç€è‰²å™¨çš„å˜é‡
varying vec3 vColor;

void main() {
  // è®¡ç®—è£å‰ªç©ºé—´ä½ç½®
  gl_Position = uModelViewProjectionMatrix * vec4(aPosition, 1.0);

  // ä¼ é€’é¡¶ç‚¹é¢œè‰²ç»™ç‰‡æ®µç€è‰²å™¨
  vColor = aColor;
}</code></pre>
            </div>

            <div class="explanation">
              <h4>varying å˜é‡ï¼š</h4>
              <ul>
                <li>ç”¨äºä»é¡¶ç‚¹ç€è‰²å™¨å‘ç‰‡æ®µç€è‰²å™¨ä¼ é€’æ•°æ®</li>
                <li>åœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­èµ‹å€¼ï¼Œåœ¨ç‰‡æ®µç€è‰²å™¨ä¸­è¯»å–</li>
                <li>åœ¨å…‰æ …åŒ–è¿‡ç¨‹ä¸­ä¼šè¢«æ’å€¼å¤„ç†</li>
                <li>åç§°å¿…é¡»åœ¨é¡¶ç‚¹å’Œç‰‡æ®µç€è‰²å™¨ä¸­ä¿æŒä¸€è‡´</li>
              </ul>
            </div>
          </div>

          <div class="card">
            <h3>é¡¶ç‚¹åŠ¨ç”»ç¤ºä¾‹</h3>
            <div class="code-sample">
              <pre><code>attribute vec3 aPosition;
attribute float aOffset; // æ¯ä¸ªé¡¶ç‚¹çš„åç§»é‡

uniform mat4 uModelViewProjectionMatrix;
uniform float uTime; // æ—¶é—´ç»Ÿä¸€å˜é‡

varying vec3 vPosition;

void main() {
  // åŸºäºæ—¶é—´è®¡ç®—æ­£å¼¦æ³¢åç§»
  float wave = sin(uTime + aOffset * 3.0) * 0.2;

  // åˆ›å»ºæ–°ä½ç½®
  vec3 newPosition = aPosition;
  newPosition.y += wave;

  // è®¡ç®—è£å‰ªç©ºé—´ä½ç½®
  gl_Position = uModelViewProjectionMatrix * vec4(newPosition, 1.0);

  // ä¼ é€’ä½ç½®ç»™ç‰‡æ®µç€è‰²å™¨
  vPosition = newPosition;
}</code></pre>
            </div>

            <div class="explanation">
              <h4>é¡¶ç‚¹åŠ¨ç”»æŠ€æœ¯ï¼š</h4>
              <ul>
                <li>ä½¿ç”¨æ—¶é—´ç»Ÿä¸€å˜é‡(uTime)é©±åŠ¨åŠ¨ç”»</li>
                <li>é€šè¿‡æ•°å­¦å‡½æ•°(å¦‚sin, cos)è®¡ç®—é¡¶ç‚¹åç§»</li>
                <li>æ¯ä¸ªé¡¶ç‚¹å¯ä»¥ä½¿ç”¨ä¸åŒçš„åç§»é‡(aOffset)</li>
                <li>å¸¸ç”¨äºåˆ›å»ºæ³¢æµªã€æ——å¸œé£˜åŠ¨ç­‰æ•ˆæœ</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- åº”ç”¨ç¤ºä¾‹éƒ¨åˆ† -->
        <section v-show="activeSection === 2">
          <h2>é¡¶ç‚¹ç€è‰²å™¨åº”ç”¨ç¤ºä¾‹</h2>

          <div class="card">
            <h3>é¡¶ç‚¹å˜æ¢å¯è§†åŒ–</h3>
            <div class="visualization-container">
              <div class="controls">
                <div class="control-group">
                  <label>å˜æ¢ç±»å‹:</label>
                  <select v-model="transformType">
                    <option value="translation">å¹³ç§»</option>
                    <option value="rotation">æ—‹è½¬</option>
                    <option value="scale">ç¼©æ”¾</option>
                    <option value="wave">æ³¢æµªæ•ˆæœ</option>
                  </select>
                </div>

                <div class="control-group" v-if="transformType === 'translation'">
                  <label>Xè½´å¹³ç§»: {{ translation.x.toFixed(2) }}</label>
                  <input type="range" v-model="translation.x" min="-1" max="1" step="0.01">
                </div>

                <div class="control-group" v-if="transformType === 'rotation'">
                  <label>æ—‹è½¬è§’åº¦: {{ rotationAngle }}Â°</label>
                  <input type="range" v-model="rotationAngle" min="0" max="360">
                </div>

                <div class="control-group" v-if="transformType === 'scale'">
                  <label>ç¼©æ”¾æ¯”ä¾‹: {{ scaleFactor.toFixed(2) }}</label>
                  <input type="range" v-model="scaleFactor" min="0.1" max="2" step="0.01">
                </div>

                <div class="control-group" v-if="transformType === 'wave'">
                  <label>æ³¢æµªé¢‘ç‡: {{ waveFrequency.toFixed(2) }}</label>
                  <input type="range" v-model="waveFrequency" min="0.5" max="5" step="0.1">
                </div>
              </div>

              <div class="canvas-container">
                <canvas ref="webglCanvas"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>é¡¶ç‚¹ç€è‰²å™¨åœ¨3Dæ¸²æŸ“ä¸­çš„ä½œç”¨</h3>
            <div class="role-grid">
              <div class="role">
                <div class="icon">ğŸ§©</div>
                <h4>æ¨¡å‹å˜æ¢</h4>
                <p>å°†æ¨¡å‹ä»æœ¬åœ°åæ ‡ç©ºé—´è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ç©ºé—´</p>
              </div>
              <div class="role">
                <div class="icon">ğŸ‘ï¸</div>
                <h4>è§†å›¾å˜æ¢</h4>
                <p>æ ¹æ®ç›¸æœºä½ç½®è°ƒæ•´é¡¶ç‚¹ä½ç½®</p>
              </div>
              <div class="role">
                <div class="icon">ğŸ“·</div>
                <h4>æŠ•å½±å˜æ¢</h4>
                <p>å°†3Dé¡¶ç‚¹æŠ•å½±åˆ°2Dè£å‰ªç©ºé—´</p>
              </div>
              <div class="role">
                <div class="icon">ğŸ­</div>
                <h4>è’™çš®åŠ¨ç”»</h4>
                <p>å®ç°éª¨éª¼åŠ¨ç”»ä¸­çš„é¡¶ç‚¹å˜æ¢</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <footer>
      <p>é¡¶ç‚¹ç€è‰²å™¨æ˜¯WebGLæ¸²æŸ“ç®¡çº¿çš„æ ¸å¿ƒç»„ä»¶ï¼ŒæŒæ¡å…¶å·¥ä½œåŸç†å’Œç¼–ç¨‹æŠ€å·§æ˜¯åˆ›å»ºé«˜æ€§èƒ½WebGLåº”ç”¨çš„å…³é”®ã€‚</p>
      <div class="footer-links">
        <a href="https://webglfundamentals.org" target="_blank">WebGLåŸºç¡€æ•™ç¨‹</a>
        <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGL_API" target="_blank">MDN WebGLæ–‡æ¡£</a>
        <a href="https://thebookofshaders.com" target="_blank">ç€è‰²å™¨ä¹‹ä¹¦</a>
      </div>
    </footer>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch } from 'vue';

// å¯¼èˆªçŠ¶æ€
const activeSection = ref(0);
const navItems = ref([
  { title: 'åŸºç¡€æ¦‚å¿µ' },
  { title: 'ä»£ç å®ç°' },
  { title: 'åº”ç”¨ç¤ºä¾‹' }
]);

// å˜æ¢æ§åˆ¶
const transformType = ref('translation');
const translation = ref({ x: 0, y: 0, z: 0 });
const rotationAngle = ref(0);
const scaleFactor = ref(1);
const waveFrequency = ref(2);

// WebGLç›¸å…³å¼•ç”¨
const webglCanvas = ref<HTMLCanvasElement | null>(null);
let gl: WebGLRenderingContext | null = null;
let program: WebGLProgram | null = null;
let animationFrameId: number | null = null;

// é¡¶ç‚¹æ•°æ®
const vertices = new Float32Array([
  // å‰é¢
  -0.5, -0.5, 0.5,
  0.5, -0.5, 0.5,
  0.5, 0.5, 0.5,
  -0.5, 0.5, 0.5,

  // åé¢
  -0.5, -0.5, -0.5,
  0.5, -0.5, -0.5,
  0.5, 0.5, -0.5,
  -0.5, 0.5, -0.5,

  // å·¦é¢
  -0.5, -0.5, -0.5,
  -0.5, -0.5, 0.5,
  -0.5, 0.5, 0.5,
  -0.5, 0.5, -0.5,

  // å³é¢
  0.5, -0.5, -0.5,
  0.5, -0.5, 0.5,
  0.5, 0.5, 0.5,
  0.5, 0.5, -0.5,

  // é¡¶é¢
  -0.5, 0.5, -0.5,
  0.5, 0.5, -0.5,
  0.5, 0.5, 0.5,
  -0.5, 0.5, 0.5,

  // åº•é¢
  -0.5, -0.5, -0.5,
  0.5, -0.5, -0.5,
  0.5, -0.5, 0.5,
  -0.5, -0.5, 0.5
]);

// ç´¢å¼•æ•°æ®
const indices = new Uint16Array([
  0, 1, 2, 0, 2, 3,    // å‰é¢
  4, 5, 6, 4, 6, 7,    // åé¢
  8, 9, 10, 8, 10, 11,  // å·¦é¢
  12, 13, 14, 12, 14, 15,   // å³é¢
  16, 17, 18, 16, 18, 19,   // é¡¶é¢
  20, 21, 22, 20, 22, 23    // åº•é¢
]);

// åˆå§‹åŒ–WebGL
const initWebGL = () => {
  if (!webglCanvas.value) return;

  // è·å–WebGLä¸Šä¸‹æ–‡
  gl = webglCanvas.value.getContext('webgl');
  if (!gl) {
    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebGL');
    return;
  }

  // è®¾ç½®è§†å£å¤§å°
  const canvas = webglCanvas.value;
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  gl.viewport(0, 0, canvas.width, canvas.height);

  // åˆ›å»ºç€è‰²å™¨ç¨‹åº
  program = createShaderProgram(gl);
  if (!program) return;

  // è®¾ç½®é¡¶ç‚¹ç¼“å†²åŒº
  setupVertexBuffer(gl, program);

  // å¼€å§‹æ¸²æŸ“å¾ªç¯
  render();
};

// åˆ›å»ºç€è‰²å™¨ç¨‹åº
const createShaderProgram = (gl: WebGLRenderingContext): WebGLProgram | null => {
  // é¡¶ç‚¹ç€è‰²å™¨æºç 
  const vsSource = `
    attribute vec3 aPosition;

    uniform mat4 uModelViewMatrix;
    uniform mat4 uProjectionMatrix;
    uniform float uTime;
    uniform float uWaveFrequency;
    uniform vec3 uTranslation;
    uniform float uRotationAngle;
    uniform float uScale;
    uniform int uTransformType;

    void main() {
      vec3 position = aPosition;

      // åº”ç”¨ç¼©æ”¾
      if (uTransformType == 2) {
        position *= uScale;
      }

      // åº”ç”¨å¹³ç§»
      if (uTransformType == 0) {
        position += uTranslation;
      }

      // åº”ç”¨æ—‹è½¬
      if (uTransformType == 1) {
        float angle = radians(uRotationAngle);
        mat3 rotationMatrix = mat3(
          cos(angle), 0.0, sin(angle),
          0.0, 1.0, 0.0,
          -sin(angle), 0.0, cos(angle)
        );
        position = rotationMatrix * position;
      }

      // åº”ç”¨æ³¢æµªæ•ˆæœ
      if (uTransformType == 3) {
        float wave = sin(uTime + position.x * uWaveFrequency) * 0.1;
        position.y += wave;
      }

      // è®¡ç®—æœ€ç»ˆä½ç½®
      gl_Position = uProjectionMatrix * uModelViewMatrix * vec4(position, 1.0);
    }
  `;

  // ç‰‡æ®µç€è‰²å™¨æºç 
  const fsSource = `
    precision mediump float;

    void main() {
      // ç®€å•çš„é¢œè‰²
      gl_FragColor = vec4(0.2, 0.6, 0.9, 1.0);
    }
  `;

  // ç¼–è¯‘ç€è‰²å™¨
  const vertexShader = compileShader(gl, gl.VERTEX_SHADER, vsSource);
  const fragmentShader = compileShader(gl, gl.FRAGMENT_SHADER, fsSource);

  if (!vertexShader || !fragmentShader) return null;

  // åˆ›å»ºç¨‹åºå¹¶é“¾æ¥
  const program = gl.createProgram();
  if (!program) return null;

  gl.attachShader(program, vertexShader);
  gl.attachShader(program, fragmentShader);
  gl.linkProgram(program);

  if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
    console.error('æ— æ³•åˆå§‹åŒ–ç€è‰²å™¨ç¨‹åº: ' + gl.getProgramInfoLog(program));
    return null;
  }

  gl.useProgram(program);
  return program;
};

// ç¼–è¯‘ç€è‰²å™¨
const compileShader = (
  gl: WebGLRenderingContext,
  type: number,
  source: string
): WebGLShader | null => {
  const shader = gl.createShader(type);
  if (!shader) return null;

  gl.shaderSource(shader, source);
  gl.compileShader(shader);

  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
    console.error('ç€è‰²å™¨ç¼–è¯‘é”™è¯¯: ' + gl.getShaderInfoLog(shader));
    gl.deleteShader(shader);
    return null;
  }

  return shader;
};

// è®¾ç½®é¡¶ç‚¹ç¼“å†²åŒº
const setupVertexBuffer = (
  gl: WebGLRenderingContext,
  program: WebGLProgram
) => {
  // åˆ›å»ºé¡¶ç‚¹ç¼“å†²åŒº
  const vertexBuffer = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
  gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

  // è·å–ä½ç½®å±æ€§ä½ç½®å¹¶å¯ç”¨
  const positionLocation = gl.getAttribLocation(program, 'aPosition');
  gl.enableVertexAttribArray(positionLocation);
  gl.vertexAttribPointer(positionLocation, 3, gl.FLOAT, false, 0, 0);

  // åˆ›å»ºç´¢å¼•ç¼“å†²åŒº
  const indexBuffer = gl.createBuffer();
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);
};

// æ¸²æŸ“å¾ªç¯
const render = () => {
  if (!gl || !program || !webglCanvas.value) return;

  // æ¸…é™¤ç”»å¸ƒ
  gl.clearColor(0.95, 0.95, 0.98, 1.0);
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

  // å¯ç”¨æ·±åº¦æµ‹è¯•
  gl.enable(gl.DEPTH_TEST);

  // è®¾ç½®æŠ•å½±çŸ©é˜µ
  const projectionMatrix = new Float32Array(16);
  const aspect = webglCanvas.value.clientWidth / webglCanvas.value.clientHeight;
  const fieldOfView = Math.PI / 4; // 45åº¦
  const zNear = 0.1;
  const zFar = 100.0;

  // é€è§†æŠ•å½±çŸ©é˜µ
  const f = 1.0 / Math.tan(fieldOfView / 2);
  projectionMatrix[0] = f / aspect;
  projectionMatrix[5] = f;
  projectionMatrix[10] = -(zFar + zNear) / (zFar - zNear);
  projectionMatrix[11] = -1;
  projectionMatrix[14] = -(2 * zFar * zNear) / (zFar - zNear);

  // è®¾ç½®æ¨¡å‹è§†å›¾çŸ©é˜µ
  const modelViewMatrix = new Float32Array(16);
  // å•ä½çŸ©é˜µ
  for (let i = 0; i < 16; i++) modelViewMatrix[i] = i % 5 === 0 ? 1 : 0;

  // ç§»åŠ¨ç›¸æœºä½ç½®
  modelViewMatrix[14] = -3.0; // åœ¨zè½´è´Ÿæ–¹å‘ç§»åŠ¨

  // è·å–ç»Ÿä¸€å˜é‡ä½ç½®
  const projectionLocation = gl.getUniformLocation(program, 'uProjectionMatrix');
  const modelViewLocation = gl.getUniformLocation(program, 'uModelViewMatrix');
  const timeLocation = gl.getUniformLocation(program, 'uTime');
  const waveLocation = gl.getUniformLocation(program, 'uWaveFrequency');
  const translationLocation = gl.getUniformLocation(program, 'uTranslation');
  const rotationLocation = gl.getUniformLocation(program, 'uRotationAngle');
  const scaleLocation = gl.getUniformLocation(program, 'uScale');
  const transformLocation = gl.getUniformLocation(program, 'uTransformType');

  // è®¾ç½®ç»Ÿä¸€å˜é‡å€¼
  gl.uniformMatrix4fv(projectionLocation, false, projectionMatrix);
  gl.uniformMatrix4fv(modelViewLocation, false, modelViewMatrix);
  gl.uniform1f(timeLocation, performance.now() / 1000);
  gl.uniform1f(waveLocation, waveFrequency.value);
  gl.uniform3f(
    translationLocation,
    translation.value.x,
    translation.value.y,
    translation.value.z
  );
  gl.uniform1f(rotationLocation, rotationAngle.value);
  gl.uniform1f(scaleLocation, scaleFactor.value);

  // è®¾ç½®å˜æ¢ç±»å‹
  const transformTypeMap: Record<string, number> = {
    'translation': 0,
    'rotation': 1,
    'scale': 2,
    'wave': 3
  };
  gl.uniform1i(transformLocation, transformTypeMap[transformType.value]);

  // ç»˜åˆ¶å›¾å½¢
  gl.drawElements(gl.TRIANGLES, indices.length, gl.UNSIGNED_SHORT, 0);

  // ç»§ç»­åŠ¨ç”»å¾ªç¯
  animationFrameId = requestAnimationFrame(render);
};

// ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–WebGL
onMounted(() => {
  initWebGL();

  // ç›‘å¬çª—å£å¤§å°å˜åŒ–
  window.addEventListener('resize', initWebGL);
});

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†èµ„æº
onUnmounted(() => {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  window.removeEventListener('resize', initWebGL);
});

// ç›‘å¬å˜æ¢ç±»å‹å˜åŒ–
watch(transformType, () => {
  // é‡ç½®å‚æ•°
  translation.value = { x: 0, y: 0, z: 0 };
  rotationAngle.value = 0;
  scaleFactor.value = 1;
  waveFrequency.value = 2;
});
</script>

<style scoped lang="less">
@primary-color: #5e35b1;
@secondary-color: #7e57c2;
@accent-color: #d1c4e9;
@background-color: #f9f9f9;
@card-color: #ffffff;
@text-color: #333333;
@border-color: #e0e0e0;

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

.vertex-shader-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: @text-color;
  background-color: @background-color;
  line-height: 1.6;

  header {
    text-align: center;
    margin-bottom: 30px;

    h1 {
      color: @primary-color;
      margin-bottom: 15px;
      font-size: 2.5rem;
    }

    .overview {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: lighten(@accent-color, 15%);
      border-radius: 12px;
      font-size: 1.1rem;
    }
  }

  .content-wrapper {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;

    @media (max-width: 768px) {
      flex-direction: column;
    }
  }

  .navigation {
    flex: 0 0 200px;
    display: flex;
    flex-direction: column;
    gap: 10px;

    @media (max-width: 768px) {
      flex-direction: row;
      flex-wrap: wrap;
      flex: none;
    }

    div {
      padding: 15px 20px;
      background: #f0f2f5;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;

      &:hover {
        background: #e0e0ff;
        transform: translateX(5px);

        @media (max-width: 768px) {
          transform: translateY(-3px);
        }
      }

      &.active {
        background: @primary-color;
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    }
  }

  .content {
    flex: 1;

    section {
      margin-bottom: 30px;

      h2 {
        color: @primary-color;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid @border-color;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);

      h3 {
        color: darken(@primary-color, 10%);
        margin-bottom: 20px;
        font-size: 1.4rem;
      }

      h4 {
        color: @primary-color;
        margin: 15px 0 10px;
      }

      p {
        margin-bottom: 15px;
        line-height: 1.7;
      }

      ul {
        padding-left: 25px;
        margin-bottom: 20px;

        li {
          margin-bottom: 10px;
          line-height: 1.6;
        }
      }
    }

    .illustration {
      margin: 20px 0;

      .pipeline {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        padding: 20px;
        background: #f5f7ff;
        border-radius: 8px;

        .stage {
          padding: 12px 20px;
          background: #e0e0ff;
          border-radius: 6px;
          font-weight: 500;

          &.highlight {
            background: @primary-color;
            color: white;
            font-weight: bold;
          }
        }

        .arrow {
          color: #777;
          font-weight: bold;
        }
      }
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;

      .feature {
        background: #f5f7ff;
        border-radius: 8px;
        padding: 20px;
        text-align: center;

        .icon {
          font-size: 2.5rem;
          margin-bottom: 15px;
        }

        h4 {
          margin-bottom: 10px;
          color: @primary-color;
        }
      }
    }

    .io-table {
      overflow-x: auto;

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;

        th,
        td {
          padding: 12px 15px;
          text-align: left;
          border-bottom: 1px solid @border-color;
        }

        th {
          background-color: @primary-color;
          color: white;
          font-weight: bold;
        }

        tr:nth-child(even) {
          background-color: #f5f7ff;
        }
      }
    }

    .code-sample {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      overflow-x: auto;

      pre {
        margin: 0;

        code {
          color: #f8f8f2;
          font-family: 'Fira Code', 'Courier New', monospace;
          font-size: 0.95rem;
          line-height: 1.5;

          .comment {
            color: #75715e;
          }

          .keyword {
            color: #f92672;
          }

          .function {
            color: #66d9ef;
          }

          .string {
            color: #a6e22e;
          }

          .number {
            color: #ae81ff;
          }
        }
      }
    }

    .explanation {
      background: #e9f5f1;
      border-radius: 8px;
      padding: 20px;
    }

    .visualization-container {
      display: flex;
      flex-direction: column;
      gap: 20px;

      .controls {
        background: #f5f7ff;
        border-radius: 8px;
        padding: 20px;

        .control-group {
          margin-bottom: 15px;

          label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
          }

          select,
          input {
            width: 100%;
            padding: 10px;
            border: 1px solid @border-color;
            border-radius: 6px;
            background: white;
          }
        }
      }

      .canvas-container {
        width: 100%;
        height: 400px;
        background: #2d2d2d;
        border-radius: 8px;
        overflow: hidden;

        canvas {
          width: 100%;
          height: 100%;
          display: block;
        }
      }
    }

    .role-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;

      .role {
        background: #f5f7ff;
        border-radius: 8px;
        padding: 20px;
        text-align: center;

        .icon {
          font-size: 2.5rem;
          margin-bottom: 15px;
        }

        h4 {
          margin-bottom: 10px;
          color: @primary-color;
        }
      }
    }
  }

  footer {
    margin-top: 40px;
    padding: 25px;
    background-color: lighten(@accent-color, 10%);
    border-radius: 12px;
    text-align: center;
    font-size: 1.1rem;
    border-top: 2px solid @border-color;

    p {
      margin-bottom: 15px;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;

      a {
        color: @primary-color;
        text-decoration: none;
        font-weight: 500;

        &:hover {
          text-decoration: underline;
        }
      }
    }
  }
}

@media (max-width: 768px) {
  .vertex-shader-container {
    padding: 15px;

    header h1 {
      font-size: 2rem;
    }
  }
}
</style>
