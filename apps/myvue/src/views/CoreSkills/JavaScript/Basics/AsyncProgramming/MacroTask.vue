<template>
  <div class="macrotask-container">
    <header class="header">
      <h1 class="title">JavaScript å®ä»»åŠ¡(Macrotask)</h1>
      <p class="subtitle">æ·±å…¥ç†è§£äº‹ä»¶å¾ªç¯ä¸­çš„å®ä»»åŠ¡æœºåˆ¶</p>
    </header>

    <div class="content-section">
      <h2 class="section-title">ğŸ” å®ä»»åŠ¡åŸºæœ¬æ¦‚å¿µ</h2>
      <div class="concept-card">
        <p>å®ä»»åŠ¡æ˜¯ JavaScript äº‹ä»¶å¾ªç¯ä¸­çš„ä¸€ç§ä»»åŠ¡ç±»å‹ï¼Œæ¯ä¸ªäº‹ä»¶å¾ªç¯è¿­ä»£ä¸­ä¼šæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªä»»åŠ¡ã€‚</p>
        <p>ä¸å¾®ä»»åŠ¡(Microtask)ä¸åŒï¼Œå®ä»»åŠ¡åœ¨æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¸­<b>åªæ‰§è¡Œä¸€ä¸ª</b>ï¼Œç„¶åæ£€æŸ¥å¹¶æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ã€‚</p>
      </div>
      <div class="image-placeholder">
        <div class="event-loop-image">
          <div class="loop">äº‹ä»¶å¾ªç¯</div>
          <div class="macrotask">å®ä»»åŠ¡é˜Ÿåˆ—</div>
          <div class="microtask">å¾®ä»»åŠ¡é˜Ÿåˆ—</div>
          <div class="render">æ¸²æŸ“æ­¥éª¤</div>
          <div class="arrow"></div>
        </div>
      </div>
    </div>

    <div class="content-section">
      <h2 class="section-title">ğŸ“‹ å¸¸è§çš„å®ä»»åŠ¡ç±»å‹</h2>
      <div class="task-grid">
        <div v-for="task in macrotasks" :key="task.type" class="task-card">
          <h3 class="task-type">{{ task.type }}</h3>
          <div class="task-examples">
            <div v-for="(example, idx) in task.examples" :key="idx" class="example">
              <code>{{ example }}</code>
            </div>
          </div>
          <p class="task-desc">{{ task.desc }}</p>
        </div>
      </div>
    </div>

    <div class="content-section">
      <h2 class="section-title">âš ï¸ å®ä»»åŠ¡è¿‡å¤šçš„é—®é¢˜</h2>
      <div class="problem-card warning">
        <h3>å®ä»»åŠ¡é˜Ÿåˆ—é˜»å¡</h3>
        <p>å½“å®ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰å¤ªå¤šä»»åŠ¡æ—¶ï¼Œä¼šå¯¼è‡´ï¼š</p>
        <ul>
          <li>é¡µé¢å“åº”å˜æ…¢ï¼Œç”¨æˆ·äº¤äº’å»¶è¿Ÿ</li>
          <li>åŠ¨ç”»å¡é¡¿ï¼Œæ¸²æŸ“ä¸æµç•…</li>
          <li>é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹</li>
        </ul>
      </div>

      <h3 class="optimize-title">ä¼˜åŒ–ç­–ç•¥</h3>
      <div class="optimize-grid">
        <div v-for="opt in optimizations" :key="opt.title" class="optimize-card">
          <h4>{{ opt.title }}</h4>
          <p>{{ opt.desc }}</p>
          <pre v-if="opt.code"><code>{{ opt.code }}</code></pre>
        </div>
      </div>
    </div>

    <div class="content-section">
      <h2 class="section-title">ğŸ“ å®ä»»åŠ¡ä½¿ç”¨æ³¨æ„äº‹é¡¹</h2>
      <div class="note-grid">
        <div v-for="note in notes" :key="note.title" class="note-card">
          <h3>{{ note.title }}</h3>
          <p>{{ note.content }}</p>
        </div>
      </div>
    </div>

    <footer class="footer">
      <p>å®ä»»åŠ¡æ˜¯ JavaScript å¹¶å‘æ¨¡å‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œåˆç†ä½¿ç”¨å¯ä»¥æå‡åº”ç”¨æ€§èƒ½</p>
    </footer>
  </div>
</template>

<script setup lang="ts">
interface Macrotask {
  type: string;
  examples: string[];
  desc: string;
}

interface Optimization {
  title: string;
  desc: string;
  code?: string;
}

interface Note {
  title: string;
  content: string;
}

const macrotasks: Macrotask[] = [
  {
    type: 'å®šæ—¶å™¨',
    examples: [
      'setTimeout(callback, delay)',
      'setInterval(callback, delay)',
      'requestAnimationFrame(callback)'
    ],
    desc: 'å»¶è¿Ÿæ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ³¨æ„ requestAnimationFrame æ˜¯ç‰¹æ®Šçš„å®ä»»åŠ¡ï¼Œåœ¨æ¸²æŸ“å‰æ‰§è¡Œ'
  },
  {
    type: 'ç½‘ç»œè¯·æ±‚',
    examples: [
      'XMLHttpRequest å›è°ƒ',
      'fetch().then() çš„å›è°ƒ',
      'WebSocket äº‹ä»¶å›è°ƒ'
    ],
    desc: 'ç½‘ç»œè¯·æ±‚å®Œæˆåçš„å›è°ƒéƒ½æ˜¯å®ä»»åŠ¡ï¼Œå³ä½¿ä½¿ç”¨ Promise å°è£…'
  },
  {
    type: 'DOM äº‹ä»¶',
    examples: [
      'element.addEventListener() å›è°ƒ',
      'window.onload å›è°ƒ',
      'UI äº¤äº’äº‹ä»¶å›è°ƒ'
    ],
    desc: 'ç”¨æˆ·äº¤äº’è§¦å‘çš„äº‹ä»¶å¤„ç†å‡½æ•°éƒ½æ˜¯å®ä»»åŠ¡'
  },
  {
    type: 'I/O æ“ä½œ',
    examples: [
      'Node.js ä¸­çš„ fs.readFile å›è°ƒ',
      'IndexedDB æ“ä½œå›è°ƒ',
      'LocalStorage æ“ä½œå®Œæˆå›è°ƒ'
    ],
    desc: 'æ–‡ä»¶ç³»ç»Ÿæˆ–æ•°æ®åº“æ“ä½œå®Œæˆåçš„å›è°ƒ'
  },
  {
    type: 'UI æ¸²æŸ“',
    examples: [
      'æµè§ˆå™¨é‡æ’/é‡ç»˜',
      'CSS åŠ¨ç”»å›è°ƒ',
      'è¿‡æ¸¡æ•ˆæœç»“æŸäº‹ä»¶'
    ],
    desc: 'æµè§ˆå™¨æ¸²æŸ“ç®¡é“çš„å„ä¸ªé˜¶æ®µä¹Ÿæ˜¯å®ä»»åŠ¡'
  }
];

const optimizations: Optimization[] = [
  {
    title: 'ä»»åŠ¡æ‹†åˆ†',
    desc: 'å°†é•¿ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹',
    code: '// ä½¿ç”¨ setTimeout æ‹†åˆ†ä»»åŠ¡\nfunction processChunk(data, chunkSize, callback) {\n  let index = 0;\n  function doChunk() {\n    const chunk = data.slice(index, index + chunkSize);\n    // å¤„ç†å½“å‰å—...\n    index += chunkSize;\n    if (index < data.length) {\n      setTimeout(doChunk, 0);\n    } else {\n      callback();\n    }\n  }\n  doChunk();\n}'
  },
  {
    title: 'ä½¿ç”¨ Web Workers',
    desc: 'å°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ç§»åˆ° Worker çº¿ç¨‹',
    code: '// ä¸»çº¿ç¨‹\nconst worker = new Worker("worker.js");\nworker.postMessage(data);\nworker.onmessage = (e) => {\n  // å¤„ç†ç»“æœ\n};\n\n// worker.js\nself.onmessage = (e) => {\n  const result = heavyComputation(e.data);\n  self.postMessage(result);\n};'
  },
  {
    title: 'åˆç†ä½¿ç”¨ requestAnimationFrame',
    desc: 'åŠ¨ç”»ç›¸å…³ä»»åŠ¡ä½¿ç”¨ rAF å¯ä»¥å¯¹é½æµè§ˆå™¨åˆ·æ–°ç‡',
    code: 'function animate() {\n  // åŠ¨ç”»é€»è¾‘...\n  requestAnimationFrame(animate);\n}\nrequestAnimationFrame(animate);'
  },
  {
    title: 'é¿å…åµŒå¥—å®šæ—¶å™¨',
    desc: 'å¤šå±‚åµŒå¥—çš„ setTimeout/setInterval ä¼šå¯¼è‡´ä»»åŠ¡å †ç§¯',
    code: '// ä¸æ¨è\nfunction recursiveTimeout() {\n  // ä»»åŠ¡é€»è¾‘...\n  setTimeout(recursiveTimeout, 0);\n}\n\n// æ¨è\nfunction task() {\n  // ä»»åŠ¡é€»è¾‘...\n  if (shouldContinue) {\n    setTimeout(task, reasonableDelay);\n  }\n}'
  }
];

const notes: Note[] = [
  {
    title: 'æ‰§è¡Œé¡ºåº',
    content: 'å®ä»»åŠ¡æŒ‰å…¥é˜Ÿé¡ºåºæ‰§è¡Œï¼Œä½†ä¸åŒç±»å‹çš„å®ä»»åŠ¡å¯èƒ½æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼ˆå¦‚ç”¨æˆ·äº¤äº’äº‹ä»¶é€šå¸¸ä¼˜å…ˆçº§è¾ƒé«˜ï¼‰'
  },
  {
    title: 'ä¸å¾®ä»»åŠ¡çš„åŒºåˆ«',
    content: 'å¾®ä»»åŠ¡(Promiseã€MutationObserverç­‰)ä¼šåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œåç«‹å³æ‰§è¡Œï¼Œè€Œå®ä»»åŠ¡è¦ç­‰åˆ°ä¸‹æ¬¡äº‹ä»¶å¾ªç¯'
  },
  {
    title: 'é›¶å»¶è¿Ÿå®šæ—¶å™¨',
    content: 'setTimeout(callback, 0) å¹¶ä¸çœŸçš„ç«‹å³æ‰§è¡Œï¼Œåªæ˜¯å°½å¿«æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—'
  },
  {
    title: 'Node.js å·®å¼‚',
    content: 'Node.js ä¸­ setImmediate æ˜¯ç‰¹æ®Šçš„å®ä»»åŠ¡ï¼Œé€šå¸¸æ¯” setTimeout(fn, 0) æ›´å¿«æ‰§è¡Œ'
  },
  {
    title: 'é•¿ä»»åŠ¡å½±å“',
    content: 'å•ä¸ªå®ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ï¼Œå»ºè®®æ§åˆ¶åœ¨ 50ms ä»¥å†…'
  },
  {
    title: 'ä»»åŠ¡ä¼˜å…ˆçº§',
    content: 'æµè§ˆå™¨ä¼šä¼˜å…ˆå¤„ç†ç”¨æˆ·äº¤äº’ç›¸å…³çš„å®ä»»åŠ¡ï¼ˆå¦‚ç‚¹å‡»äº‹ä»¶ï¼‰ï¼Œç„¶åæ˜¯æ¸²æŸ“ä»»åŠ¡ï¼Œæœ€åæ˜¯å…¶ä»–ä»»åŠ¡'
  }
];
</script>

<style lang="less" scoped>

.macrotask-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 2rem;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  color: #2c3e50;
  background-color: #fff;
  line-height: 1.6;
}

.header {
  text-align: center;
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #eaecef;

  .title {
    font-size: 2.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2c3e50;
    background: linear-gradient(90deg, #42b983, #3498db);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  .subtitle {
    font-size: 1.1rem;
    color: #7f8c8d;
    font-weight: 400;
  }
}

.content-section {
  margin-bottom: 2.5rem;

  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.2rem;
    color: #2c3e50;
    border-left: 4px solid #42b983;
    padding-left: 0.8rem;
  }
}

.concept-card {
  background-color: #f8f9fa;
  padding: 1.2rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  border-left: 4px solid #3498db;

  p {
    margin: 0.5rem 0;

    b {
      color: #e74c3c;
    }
  }
}

.image-placeholder {
  background-color: #f5f7fa;
  border-radius: 8px;
  padding: 1.5rem;
  margin: 1.5rem 0;
  text-align: center;
  color: #7f8c8d;

  .event-loop-image {
    position: relative;
    height: 120px;

    .loop, .macrotask, .microtask, .render {
      position: absolute;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .loop {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #42b983;
      color: white;
    }

    .macrotask {
      top: 20%;
      left: 20%;
      background-color: #3498db;
      color: white;
    }

    .microtask {
      top: 20%;
      right: 20%;
      background-color: #9b59b6;
      color: white;
    }

    .render {
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #e74c3c;
      color: white;
    }

    .arrow {
      position: absolute;
      width: 20px;
      height: 20px;
      border-right: 2px solid #7f8c8d;
      border-bottom: 2px solid #7f8c8d;
      transform: rotate(-45deg);
      top: 40%;
      left: 30%;
    }
  }
}

.task-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.2rem;
}

.task-card {
  background-color: #fff;
  border-radius: 8px;
  padding: 1.2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #eaecef;
  transition: transform 0.2s;

  &:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .task-type {
    font-size: 1.2rem;
    margin-top: 0;
    margin-bottom: 0.8rem;
    color: #3498db;
  }

  .task-examples {
    margin-bottom: 0.8rem;

    .example {
      background-color: #f8f9fa;
      padding: 0.5rem;
      margin-bottom: 0.3rem;
      border-radius: 4px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 0.85rem;
      overflow-x: auto;
    }
  }

  .task-desc {
    font-size: 0.9rem;
    color: #555;
    margin: 0;
  }
}

.problem-card {
  background-color: #fff8f0;
  padding: 1.2rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  border-left: 4px solid #e67e22;

  &.warning {
    background-color: #fff5f5;
    border-left-color: #e74c3c;
  }

  h3 {
    font-size: 1.2rem;
    margin-top: 0;
    color: #e74c3c;
  }

  ul {
    padding-left: 1.2rem;

    li {
      margin-bottom: 0.3rem;
    }
  }
}

.optimize-title {
  font-size: 1.3rem;
  color: #2c3e50;
  margin: 1.5rem 0 1rem;
}

.optimize-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.2rem;
}

.optimize-card {
  background-color: #fff;
  border-radius: 8px;
  padding: 1.2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #eaecef;

  h4 {
    font-size: 1.1rem;
    margin-top: 0;
    color: #42b983;
  }

  p {
    font-size: 0.9rem;
    color: #555;
  }

  pre {
    background-color: #f8f9fa;
    padding: 0.8rem;
    border-radius: 4px;
    overflow-x: auto;
    margin: 0.8rem 0 0;

    code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 0.8rem;
      color: #333;
    }
  }
}

.note-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.2rem;
}

.note-card {
  background-color: #fff;
  border-radius: 8px;
  padding: 1.2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid #eaecef;

  h3 {
    font-size: 1.1rem;
    margin-top: 0;
    color: #3498db;
  }

  p {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0;
  }
}

.footer {
  text-align: center;
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid #eaecef;
  color: #7f8c8d;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .macrotask-container {
    padding: 1rem;
  }

  .task-grid, .optimize-grid, .note-grid {
    grid-template-columns: 1fr;
  }

  .header .title {
    font-size: 1.8rem;
  }
}
</style>
