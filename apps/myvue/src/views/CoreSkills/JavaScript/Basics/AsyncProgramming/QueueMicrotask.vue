<template>
  <div class="microtask-container">
    <header class="header">
      <h1>JavaScript queueMicrotask ä»‹ç»</h1>
      <p>æ·±å…¥ç†è§£å¾®ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶åŠå…¶åº”ç”¨</p>
    </header>

    <div class="content-grid">
      <!-- æ¦‚å¿µéƒ¨åˆ† -->
      <section class="card concept">
        <div class="section-header">
          <div class="icon">ğŸ”</div>
          <h2>æ¦‚å¿µè§£æ</h2>
        </div>
        <div class="content">
          <p class="definition">
            <code>queueMicrotask()</code>
            æ˜¯ä¸€ä¸ªå°†å‡½æ•°æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—çš„å…¨å±€æ–¹æ³•ï¼Œç”¨äºåœ¨å½“å‰ä»»åŠ¡å®Œæˆåã€æ¸²æŸ“å‰æ‰§è¡Œã€‚
          </p>

          <div class="event-loop">
            <h3>äº‹ä»¶å¾ªç¯ä¸­çš„ä½ç½®</h3>
            <div class="loop-diagram">
              <div class="loop-item">1. æ‰§è¡Œå®ä»»åŠ¡</div>
              <div class="loop-arrow">â†’</div>
              <div class="loop-item active">2. æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡</div>
              <div class="loop-arrow">â†’</div>
              <div class="loop-item">3. æ¸²æŸ“æ›´æ–°</div>
              <div class="loop-arrow">â†’</div>
              <div class="loop-item">4. ä¸‹ä¸€ä¸ªå®ä»»åŠ¡</div>
            </div>
          </div>

          <div class="comparison">
            <h3>ä¸å…¶ä»–å¼‚æ­¥æ–¹æ³•çš„æ¯”è¾ƒ</h3>
            <div class="comparison-grid">
              <div class="method">
                <h4>queueMicrotask</h4>
                <p>å¾®ä»»åŠ¡é˜Ÿåˆ—</p>
                <div class="priority">é«˜ä¼˜å…ˆçº§</div>
              </div>
              <div class="method">
                <h4>Promise</h4>
                <p>å¾®ä»»åŠ¡é˜Ÿåˆ—</p>
                <div class="priority">é«˜ä¼˜å…ˆçº§</div>
              </div>
              <div class="method">
                <h4>setTimeout</h4>
                <p>å®ä»»åŠ¡é˜Ÿåˆ—</p>
                <div class="priority">ä½ä¼˜å…ˆçº§</div>
              </div>
              <div class="method">
                <h4>requestAnimationFrame</h4>
                <p>æ¸²æŸ“å‰æ‰§è¡Œ</p>
                <div class="priority">ä¸­ä¼˜å…ˆçº§</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ä½œç”¨éƒ¨åˆ† -->
      <section class="card purpose">
        <div class="section-header">
          <div class="icon">ğŸ¯</div>
          <h2>æ ¸å¿ƒä½œç”¨</h2>
        </div>

        <div class="content">
          <div class="purpose-grid">
            <div class="purpose-item">
              <div class="purpose-icon">âš¡</div>
              <h3>å¼‚æ­¥é«˜ä¼˜å…ˆçº§æ‰§è¡Œ</h3>
              <p>åœ¨å½“å‰ä»»åŠ¡å®Œæˆåç«‹å³æ‰§è¡Œï¼Œæ— éœ€ç­‰å¾…æ¸²æŸ“</p>
            </div>
            <div class="purpose-item">
              <div class="purpose-icon">ğŸ”„</div>
              <h3>çŠ¶æ€ä¸€è‡´æ€§</h3>
              <p>ç¡®ä¿DOMæ›´æ–°å‰å®Œæˆç›¸å…³æ“ä½œ</p>
            </div>
            <div class="purpose-item">
              <div class="purpose-icon">ğŸ“¦</div>
              <h3>æ‰¹å¤„ç†æ“ä½œ</h3>
              <p>æ”¶é›†å¤šä¸ªæ“ä½œä¸€æ¬¡æ€§æ‰§è¡Œ</p>
            </div>
            <div class="purpose-item">
              <div class="purpose-icon">ğŸš«</div>
              <h3>é¿å…æ¸²æŸ“é˜»å¡</h3>
              <p>æ›¿ä»£setTimeout(0)é¿å…å»¶è¿Ÿ</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <section class="card usage">
        <div class="section-header">
          <div class="icon">ğŸ’»</div>
          <h2>ä½¿ç”¨æ–¹æ³•</h2>
        </div>

        <div class="content">
          <div class="basic-usage">
            <h3>åŸºæœ¬ç”¨æ³•</h3>
            <pre><code>// å°†å‡½æ•°åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
queueMicrotask(() => {
  console.log('å¾®ä»»åŠ¡å·²æ‰§è¡Œ');
});

console.log('åŒæ­¥ä»»åŠ¡å…ˆæ‰§è¡Œ');
// è¾“å‡ºé¡ºåº:
// åŒæ­¥ä»»åŠ¡å…ˆæ‰§è¡Œ
// å¾®ä»»åŠ¡å·²æ‰§è¡Œ</code></pre>
          </div>

          <div class="advanced-usage">
            <h3>é«˜çº§ç”¨æ³•</h3>
            <div class="code-examples">
              <div class="code-example">
                <h4>æ‰¹é‡æ›´æ–°çŠ¶æ€</h4>
                <pre><code>let count = 0;
const increment = () => {
  count++;

  // é¿å…é¢‘ç¹é‡æ¸²æŸ“
  queueMicrotask(() => {
    updateUI(count);
  });
};</code></pre>
              </div>

              <div class="code-example">
                <h4>é”™è¯¯å¤„ç†</h4>
                <pre><code>queueMicrotask(() => {
  try {
    riskyOperation();
  } catch (error) {
    handleError(error);
  }
});</code></pre>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ä½¿ç”¨åœºæ™¯ -->
      <section class="card scenarios">
        <div class="section-header">
          <div class="icon">ğŸ“‹</div>
          <h2>ä½¿ç”¨åœºæ™¯</h2>
        </div>

        <div class="content">
          <div class="scenario-grid">
            <div class="scenario">
              <div class="scenario-icon">1</div>
              <h3>ç¡®ä¿DOMä¸€è‡´æ€§</h3>
              <p>åœ¨DOMæ“ä½œåç¡®ä¿çŠ¶æ€æ›´æ–°</p>
              <pre><code>element.addEventListener('click', () => {
  // ç«‹å³æ‰§è¡ŒDOMæ“ä½œ
  element.classList.add('active');

  // å¾®ä»»åŠ¡ä¸­ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
  queueMicrotask(() => {
    updateState(element);
  });
});</code></pre>
            </div>

            <div class="scenario">
              <div class="scenario-icon">2</div>
              <h3>æ‰¹å¤„ç†æ“ä½œ</h3>
              <p>æ”¶é›†å¤šä¸ªæ“ä½œä¸€æ¬¡æ€§æ‰§è¡Œ</p>
              <pre><code>let updates = [];

function scheduleUpdate(update) {
  updates.push(update);

  if (!isUpdateScheduled) {
    isUpdateScheduled = true;
    queueMicrotask(processUpdates);
  }
}

function processUpdates() {
  // å¤„ç†æ‰€æœ‰æ›´æ–°
  updates.forEach(update => update());
  updates = [];
  isUpdateScheduled = false;
}</code></pre>
            </div>

            <div class="scenario">
              <div class="scenario-icon">3</div>
              <h3>Promiseå°è£…</h3>
              <p>åˆ›å»ºè‡ªå®šä¹‰å¼‚æ­¥é€»è¾‘</p>
              <pre><code>function asyncTask() {
  return new Promise(resolve => {
    queueMicrotask(() => {
      // æ‰§è¡Œä»»åŠ¡
      const result = compute();
      resolve(result);
    });
  });
}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- ä¼˜ç¼ºç‚¹ -->
      <section class="card pros-cons">
        <div class="section-header">
          <div class="icon">âš–ï¸</div>
          <h2>ä¼˜ç¼ºç‚¹</h2>
        </div>

        <div class="content">
          <div class="comparison">
            <div class="pros">
              <h3>ä¼˜ç‚¹</h3>
              <ul>
                <li><span class="highlight">é«˜ä¼˜å…ˆçº§</span> - åœ¨æ¸²æŸ“å‰æ‰§è¡Œ</li>
                <li><span class="highlight">é›¶å»¶è¿Ÿ</span> - æ¯”setTimeout(0)æ›´å¿«</li>
                <li><span class="highlight">æ ‡å‡†åŒ–</span> - å®˜æ–¹APIæ›¿ä»£hackæ–¹æ¡ˆ</li>
                <li><span class="highlight">è½»é‡çº§</span> - æ¯”Promise.resolve()æ›´è½»é‡</li>
                <li><span class="highlight">æ— æ¸²æŸ“é˜»å¡</span> - ä¸å½±å“UIå“åº”</li>
              </ul>
            </div>

            <div class="cons">
              <h3>ç¼ºç‚¹</h3>
              <ul>
                <li><span class="highlight">è¿‡åº¦ä½¿ç”¨é£é™©</span> - å¯èƒ½å¯¼è‡´é•¿ä»»åŠ¡</li>
                <li><span class="highlight">é”™è¯¯å¤„ç†</span> - æœªæ•è·é”™è¯¯ä¼šå¯¼è‡´å…¨å±€é”™è¯¯</li>
                <li><span class="highlight">é€’å½’é£é™©</span> - é€’å½’è°ƒç”¨å¯èƒ½é˜»å¡äº‹ä»¶å¾ªç¯</li>
                <li><span class="highlight">å…¼å®¹æ€§</span> - IEä¸æ”¯æŒï¼Œéœ€è¦polyfill</li>
                <li><span class="highlight">è°ƒè¯•å›°éš¾</span> - å¼‚æ­¥å †æ ˆè·Ÿè¸ªè¾ƒå¤æ‚</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- æœ€ä½³å®è·µ -->
      <section class="card best-practices">
        <div class="section-header">
          <div class="icon">âœ…</div>
          <h2>æœ€ä½³å®è·µ</h2>
        </div>

        <div class="content">
          <div class="practices">
            <div class="practice">
              <div class="practice-icon">1</div>
              <h3>æ›¿ä»£setTimeout(0)</h3>
              <p>ä½¿ç”¨queueMicrotaskæ›¿ä»£setTimeout(fn, 0)å®ç°æ›´åŠæ—¶çš„æ‰§è¡Œ</p>
            </div>

            <div class="practice">
              <div class="practice-icon">2</div>
              <h3>å°è£…é”™è¯¯å¤„ç†</h3>
              <p>å§‹ç»ˆåœ¨å¾®ä»»åŠ¡ä¸­å¤„ç†å¯èƒ½çš„é”™è¯¯</p>
              <pre><code>queueMicrotask(() => {
  try {
    // å¯èƒ½å‡ºé”™çš„æ“ä½œ
  } catch (error) {
    console.error('å¾®ä»»åŠ¡é”™è¯¯:', error);
  }
});</code></pre>
            </div>

            <div class="practice">
              <div class="practice-icon">3</div>
              <h3>é¿å…é•¿ä»»åŠ¡</h3>
              <p>ä¿æŒå¾®ä»»åŠ¡ç®€çŸ­ï¼Œé¿å…é˜»å¡æ¸²æŸ“</p>
            </div>

            <div class="practice">
              <div class="practice-icon">4</div>
              <h3>ä¸Promiseç»“åˆ</h3>
              <p>åœ¨Promiseé“¾ä¸­æ’å…¥å¾®ä»»åŠ¡</p>
              <pre><code>fetchData()
  .then(data => {
    queueMicrotask(() => processData(data));
  })
  .then(result => {
    // åç»­å¤„ç†
  });</code></pre>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer class="footer">
      <p>
        queueMicrotask
        æä¾›äº†ä¸€ç§é«˜æ•ˆç®¡ç†å¼‚æ­¥æ“ä½œçš„æ–¹å¼ï¼Œåˆç†ä½¿ç”¨å¯ä»¥ä¼˜åŒ–åº”ç”¨æ€§èƒ½ï¼Œä½†éœ€æ³¨æ„é¿å…è¿‡åº¦ä½¿ç”¨å¯¼è‡´å¾®ä»»åŠ¡é˜Ÿåˆ—è¿‡è½½
      </p>
    </footer>
  </div>
</template>

<script setup lang="ts">
// ç»„ä»¶é€»è¾‘ä¸ºç©ºï¼Œä»…ç”¨äºå±•ç¤º
</script>

<style lang="less" scoped>
.microtask-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: #f8fafc;
  color: #2d3748;
  line-height: 1.6;
}

.header {
  text-align: center;
  margin-bottom: 32px;
  padding: 28px;
  background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);

  h1 {
    font-size: 2.4rem;
    margin: 0 0 12px;
    color: #1e40af;
    font-weight: 700;
  }

  p {
    font-size: 1.2rem;
    color: #4b5563;
    margin: 0;
  }
}

.content-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 24px;
  margin-bottom: 32px;
}

.card {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  padding: 28px;
  transition: all 0.25s ease;

  &:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
  }
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 24px;

  .icon {
    font-size: 1.8rem;
    margin-right: 16px;
    color: #3b82f6;
  }

  h2 {
    font-size: 1.6rem;
    margin: 0;
    color: #1e40af;
    border-bottom: 2px solid #dbeafe;
    padding-bottom: 8px;
  }
}

/* æ¦‚å¿µéƒ¨åˆ†æ ·å¼ */
.concept {
  .definition {
    font-size: 1.1rem;
    background: #eff6ff;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid #3b82f6;
    margin-bottom: 24px;
  }

  .event-loop {
    margin-bottom: 24px;

    h3 {
      font-size: 1.2rem;
      margin: 0 0 16px;
      color: #1e40af;
    }

    .loop-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;

      .loop-item {
        background: #f0f9ff;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        border: 1px solid #dbeafe;

        &.active {
          background: #dbeafe;
          border-color: #3b82f6;
          color: #1e40af;
        }
      }

      .loop-arrow {
        color: #93c5fd;
        font-weight: bold;
      }
    }
  }

  .comparison {
    h3 {
      font-size: 1.2rem;
      margin: 0 0 16px;
      color: #1e40af;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .method {
      background: #f0f9ff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid #dbeafe;
      transition: all 0.2s ease;

      &:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }

      h4 {
        margin: 0 0 8px;
        color: #1e40af;
      }

      p {
        margin: 0 0 8px;
        color: #4b5563;
        font-size: 0.95rem;
      }

      .priority {
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 20px;
        display: inline-block;

        &:after {
          content: 'ä¼˜å…ˆçº§';
          margin-left: 4px;
        }
      }
    }
  }
}

/* ä½œç”¨éƒ¨åˆ†æ ·å¼ */
.purpose {
  .purpose-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
  }

  .purpose-item {
    background: #f0fdf4;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid #bbf7d0;

    .purpose-icon {
      font-size: 2rem;
      margin-bottom: 12px;
      color: #10b981;
    }

    h3 {
      font-size: 1.2rem;
      margin: 0 0 8px;
      color: #065f46;
    }

    p {
      margin: 0;
      color: #4b5563;
      font-size: 0.95rem;
    }
  }
}

/* ä½¿ç”¨æ–¹æ³•æ ·å¼ */
.usage {
  .basic-usage,
  .advanced-usage {
    margin-bottom: 24px;

    h3 {
      font-size: 1.2rem;
      margin: 0 0 16px;
      color: #1e40af;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }
  }

  .code-examples {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;

    @media (max-width: 768px) {
      grid-template-columns: 1fr;
    }
  }

  .code-example {
    h4 {
      font-size: 1.1rem;
      margin: 0 0 12px;
      color: #1e40af;
    }
  }
}

/* ä½¿ç”¨åœºæ™¯æ ·å¼ */
.scenarios {
  .scenario-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }

  .scenario {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e2e8f0;

    .scenario-icon {
      width: 32px;
      height: 32px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 16px;
    }

    h3 {
      font-size: 1.2rem;
      margin: 0 0 8px;
      color: #1e40af;
    }

    p {
      margin: 0 0 16px;
      color: #4b5563;
      font-size: 0.95rem;
    }
  }
}

/* ä¼˜ç¼ºç‚¹æ ·å¼ */
.pros-cons {
  .comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;

    @media (max-width: 768px) {
      grid-template-columns: 1fr;
    }
  }

  .pros,
  .cons {
    h3 {
      font-size: 1.3rem;
      margin: 0 0 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    ul {
      padding-left: 20px;
      margin: 0;
    }

    li {
      margin-bottom: 12px;
      position: relative;
      padding-left: 10px;
    }

    .highlight {
      font-weight: 600;
      color: #1e40af;
      display: inline-block;
      margin-right: 4px;
    }
  }

  .pros {
    h3 {
      color: #065f46;
      border-color: #bbf7d0;
    }

    .highlight {
      color: #065f46;
    }
  }

  .cons {
    h3 {
      color: #b91c1c;
      border-color: #fecaca;
    }

    .highlight {
      color: #b91c1c;
    }
  }
}

/* æœ€ä½³å®è·µæ ·å¼ */
.best-practices {
  .practices {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }

  .practice {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e2e8f0;
    position: relative;

    .practice-icon {
      position: absolute;
      top: -12px;
      right: -12px;
      width: 30px;
      height: 30px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h3 {
      font-size: 1.2rem;
      margin: 0 0 12px;
      color: #1e40af;
    }

    p {
      margin: 0 0 16px;
      color: #4b5563;
      font-size: 0.95rem;
    }
  }
}

/* ä»£ç å—é€šç”¨æ ·å¼ */
pre {
  background: #1e293b;
  color: #e2e8f0;
  border-radius: 8px;
  padding: 16px;
  overflow-x: auto;
  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
  font-size: 0.95rem;
  line-height: 1.5;
  margin: 0 0 16px;

  code {
    color: #cbd5e1;
  }
}

/* é¡µè„šæ ·å¼ */
.footer {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  padding: 24px;
  text-align: center;
  font-size: 1.05rem;
  color: #4b5563;
  line-height: 1.7;
}
</style>
