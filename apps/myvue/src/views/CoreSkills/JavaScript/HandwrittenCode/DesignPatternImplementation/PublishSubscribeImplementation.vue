<template>
  <div class="pub-sub-container">
    <header class="header">
      <h1>å‘å¸ƒè®¢é˜…æ¨¡å¼å®ç°</h1>
      <p>æ·±å…¥ç†è§£äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒè®¾è®¡æ¨¡å¼</p>
    </header>

    <div class="content">
      <!-- æ¦‚å¿µä»‹ç»éƒ¨åˆ† -->
      <section class="concept-section">
        <div class="section-header">
          <div class="icon">ğŸ“š</div>
          <h2>å‘å¸ƒè®¢é˜…æ¨¡å¼ä»‹ç»</h2>
        </div>

        <div class="concept-grid">
          <div class="concept-card">
            <div class="concept-icon">ğŸ”„</div>
            <h3>ä»€ä¹ˆæ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Ÿ</h3>
            <p>å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯ä¸€ç§æ¶ˆæ¯èŒƒå¼ï¼Œæ¶ˆæ¯çš„å‘é€è€…ï¼ˆå‘å¸ƒè€…ï¼‰ä¸ä¼šç›´æ¥å°†æ¶ˆæ¯å‘é€ç»™ç‰¹å®šçš„æ¥æ”¶è€…ï¼ˆè®¢é˜…è€…ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡æ¶ˆæ¯é€šé“å¹¿æ’­æ¶ˆæ¯ï¼Œè®¢é˜…è€…æ¥æ”¶æ„Ÿå…´è¶£çš„æ¶ˆæ¯ã€‚</p>
          </div>

          <div class="concept-card">
            <div class="concept-icon">âš™ï¸</div>
            <h3>æ ¸å¿ƒç»„ä»¶</h3>
            <ul>
              <li><strong>å‘å¸ƒè€…(Publisher)</strong>ï¼šäº‹ä»¶è§¦å‘è€…</li>
              <li><strong>è®¢é˜…è€…(Subscriber)</strong>ï¼šäº‹ä»¶ç›‘å¬è€…</li>
              <li><strong>äº‹ä»¶é€šé“(Event Channel)</strong>ï¼šç®¡ç†äº‹ä»¶å’Œè®¢é˜…å…³ç³»</li>
              <li><strong>äº‹ä»¶(Event)</strong>ï¼šå¸¦æœ‰ç±»å‹å’Œæ•°æ®çš„æ¶ˆæ¯</li>
            </ul>
          </div>

          <div class="concept-card">
            <div class="concept-icon">ğŸ’¡</div>
            <h3>ä¸»è¦ä¼˜åŠ¿</h3>
            <ul>
              <li>ç»„ä»¶é—´è§£è€¦</li>
              <li>å¼‚æ­¥é€šä¿¡èƒ½åŠ›</li>
              <li>ä¸€å¯¹å¤šæ¶ˆæ¯å¹¿æ’­</li>
              <li>åŠ¨æ€æ·»åŠ /ç§»é™¤è®¢é˜…è€…</li>
            </ul>
          </div>

          <div class="concept-card">
            <div class="concept-icon">ğŸŒ</div>
            <h3>åº”ç”¨åœºæ™¯</h3>
            <ul>
              <li>Vue Event Bus</li>
              <li>Node.js EventEmitter</li>
              <li>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ</li>
              <li>å‰ç«¯æ¡†æ¶çŠ¶æ€ç®¡ç†</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- å®ç°æ€è·¯éƒ¨åˆ† -->
      <section class="implementation-section">
        <div class="section-header">
          <div class="icon">ğŸ”§</div>
          <h2>å®ç°æ€è·¯</h2>
        </div>

        <div class="implementation-steps">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-content">
              <h3>åˆ›å»ºäº‹ä»¶ä¸­å¿ƒ</h3>
              <p>æ„å»ºä¸€ä¸ªäº‹ä»¶é€šé“(Event Channel)ä½œä¸ºæ¶ˆæ¯ä¸­ä»‹</p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
              <h3>è®¢é˜…äº‹ä»¶</h3>
              <p>è®¢é˜…è€…æ³¨å†Œå›è°ƒå‡½æ•°åˆ°ç‰¹å®šäº‹ä»¶ç±»å‹</p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
              <h3>å‘å¸ƒäº‹ä»¶</h3>
              <p>å‘å¸ƒè€…è§¦å‘äº‹ä»¶ï¼Œäº‹ä»¶ä¸­å¿ƒé€šçŸ¥æ‰€æœ‰è®¢é˜…è€…</p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">4</div>
            <div class="step-content">
              <h3>å–æ¶ˆè®¢é˜…</h3>
              <p>è®¢é˜…è€…ä¸å†æ¥æ”¶äº‹ä»¶æ—¶ç§»é™¤å›è°ƒå‡½æ•°</p>
            </div>
          </div>
        </div>

        <div class="structure-diagram">
          <h3>æ¶æ„ç¤ºæ„å›¾</h3>
          <div class="diagram">
            <div class="publisher">
              <div>å‘å¸ƒè€…</div>
              <div class="publish-btn" @click="publishEvent">å‘å¸ƒäº‹ä»¶</div>
            </div>

            <div class="event-channel">
              <div class="channel-header">äº‹ä»¶é€šé“</div>
              <div class="events-list">
                <div v-for="(event, index) in eventLog" :key="index" class="event-item">
                  {{ event }}
                </div>
              </div>
            </div>

            <div class="subscribers">
              <div class="subscriber" v-for="(sub, index) in subscribers" :key="index">
                <div>è®¢é˜…è€… {{ index + 1 }}</div>
                <div class="messages">
                  <div v-for="(msg, i) in sub.messages" :key="i" class="message">
                    {{ msg }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ä»£ç å®ç°éƒ¨åˆ† -->
      <section class="code-section">
        <div class="section-header">
          <div class="icon">ğŸ’»</div>
          <h2>ä»£ç å®ç°</h2>
        </div>

        <div class="code-implementation">
          <div class="code-tabs">
            <button
              v-for="tab in codeTabs"
              :key="tab.id"
              :class="{ active: activeCodeTab === tab.id }"
              @click="activeCodeTab = tab.id"
            >
              {{ tab.label }}
            </button>
          </div>

          <div class="code-content">
            <div v-if="activeCodeTab === 'typescript'" class="ts-code">
              <h3>TypeScript å®ç°</h3>
              <pre><code>class EventBus {
  private events: Record&lt;string, Function[]&gt; = {};

  // è®¢é˜…äº‹ä»¶
  subscribe(eventName: string, callback: Function) {
    if (!this.events[eventName]) {
      this.events[eventName] = [];
    }
    this.events[eventName].push(callback);

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.unsubscribe(eventName, callback);
    };
  }

  // å‘å¸ƒäº‹ä»¶
  publish(eventName: string, ...args: any[]) {
    const callbacks = this.events[eventName];
    if (callbacks) {
      callbacks.forEach(callback => {
        callback(...args);
      });
    }
  }

  // å–æ¶ˆè®¢é˜…
  unsubscribe(eventName: string, callback: Function) {
    const callbacks = this.events[eventName];
    if (callbacks) {
      this.events[eventName] = callbacks.filter(cb => cb !== callback);
    }
  }

  // ä¸€æ¬¡æ€§è®¢é˜…
  once(eventName: string, callback: Function) {
    const onceWrapper = (...args: any[]) => {
      callback(...args);
      this.unsubscribe(eventName, onceWrapper);
    };
    this.subscribe(eventName, onceWrapper);
  }
}

// åˆ›å»ºå…¨å±€äº‹ä»¶æ€»çº¿
export const eventBus = new EventBus();</code></pre>
            </div>

            <div v-if="activeCodeTab === 'vue'" class="vue-code">
              <h3>åœ¨ Vue ä¸­ä½¿ç”¨</h3>
              <pre><code>// ç»„ä»¶A - å‘å¸ƒäº‹ä»¶
import { eventBus } from './eventBus';

export default {
  setup() {
    const handleClick = () => {
      // å‘å¸ƒ 'message' äº‹ä»¶
      eventBus.publish('message', 'Hello from Component A!');
    };

    return { handleClick };
  }
}

// ç»„ä»¶B - è®¢é˜…äº‹ä»¶
import { onMounted, onUnmounted } from 'vue';
import { eventBus } from './eventBus';

export default {
  setup() {
    const messages = ref&lt;string[]&gt;([]);

    const messageHandler = (msg: string) => {
      messages.value.push(msg);
    };

    onMounted(() => {
      // è®¢é˜… 'message' äº‹ä»¶
      eventBus.subscribe('message', messageHandler);
    });

    onUnmounted(() => {
      // ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…
      eventBus.unsubscribe('message', messageHandler);
    });

    return { messages };
  }
}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- å®é™…æ¼”ç¤ºéƒ¨åˆ† -->
      <section class="demo-section">
        <div class="section-header">
          <div class="icon">ğŸš€</div>
          <h2>å®é™…æ¼”ç¤º</h2>
        </div>

        <div class="demo-container">
          <div class="demo-controls">
            <button class="publish-btn" @click="publishMessage">
              å‘å¸ƒæ¶ˆæ¯äº‹ä»¶
            </button>
            <button class="publish-btn" @click="publishAlert">
              å‘å¸ƒè­¦å‘Šäº‹ä»¶
            </button>
            <button class="subscribe-btn" @click="addSubscriber">
              æ·»åŠ è®¢é˜…è€…
            </button>
          </div>

          <div class="subscribers-demo">
            <div
              v-for="(sub, index) in demoSubscribers"
              :key="sub.id"
              class="subscriber-card"
            >
              <div class="subscriber-header">
                è®¢é˜…è€… #{{ index + 1 }}
                <button class="unsubscribe-btn" @click="removeSubscriber(sub.id)">
                  å–æ¶ˆè®¢é˜…
                </button>
              </div>
              <div class="messages-container">
                <div
                  v-for="(msg, i) in sub.messages"
                  :key="i"
                  class="message"
                  :class="{'message-warning': msg.type === 'warning'}"
                >
                  {{ msg.text }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue';

// ç®€å•çš„äº‹ä»¶æ€»çº¿å®ç°
class EventBus {
  private events: Record<string, Function[]> = {};

  subscribe(eventName: string, callback: Function) {
    if (!this.events[eventName]) {
      this.events[eventName] = [];
    }
    this.events[eventName].push(callback);

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.unsubscribe(eventName, callback);
    };
  }

  publish(eventName: string, ...args: any[]) {
    const callbacks = this.events[eventName];
    if (callbacks) {
      callbacks.forEach(callback => {
        callback(...args);
      });
    }
  }

  unsubscribe(eventName: string, callback: Function) {
    const callbacks = this.events[eventName];
    if (callbacks) {
      this.events[eventName] = callbacks.filter(cb => cb !== callback);
    }
  }
}

const subscribers = ref<Array<{
  id: number;
  messages: Array<{type: string; text: string}>;
}>>([]);

// åˆ›å»ºå…¨å±€äº‹ä»¶æ€»çº¿å®ä¾‹
const eventBus = new EventBus();

// ä»£ç æ ‡ç­¾é¡µ
const codeTabs = [
  { id: 'typescript', label: 'TypeScriptå®ç°' },
  { id: 'vue', label: 'Vueä¸­ä½¿ç”¨' }
];
const activeCodeTab = ref('typescript');

// æ¼”ç¤ºæ•°æ®
const demoSubscribers = ref<Array<{
  id: number;
  messages: Array<{type: string; text: string}>;
}>>([]);

const eventLog = ref<string[]>([]);
const subscriberId = ref(1);

// æ·»åŠ è®¢é˜…è€…
const addSubscriber = () => {
  const id = subscriberId.value++;
  const messages: Array<{type: string; text: string}> = [];

  // è®¢é˜…æ¶ˆæ¯äº‹ä»¶
  const unsubscribeMessage = eventBus.subscribe('message', (text: string) => {
    messages.push({ type: 'info', text });
  });

  // è®¢é˜…è­¦å‘Šäº‹ä»¶
  const unsubscribeWarning = eventBus.subscribe('warning', (text: string) => {
    messages.push({ type: 'warning', text });
  });

  demoSubscribers.value.push({
    id,
    messages
  });

  eventLog.value.push(`è®¢é˜…è€… #${id} å·²æ³¨å†Œ`);
};

// ç§»é™¤è®¢é˜…è€…
const removeSubscriber = (id: number) => {
  demoSubscribers.value = demoSubscribers.value.filter(sub => sub.id !== id);
  eventLog.value.push(`è®¢é˜…è€… #${id} å·²å–æ¶ˆè®¢é˜…`);
};

// å‘å¸ƒæ¶ˆæ¯äº‹ä»¶
const publishMessage = () => {
  const text = `æ¶ˆæ¯äº‹ä»¶ ${new Date().toLocaleTimeString()}`;
  eventBus.publish('message', text);
  eventLog.value.push(`å‘å¸ƒæ¶ˆæ¯: ${text}`);
};

// å‘å¸ƒè­¦å‘Šäº‹ä»¶
const publishAlert = () => {
  const text = `è­¦å‘Šäº‹ä»¶ ${new Date().toLocaleTimeString()}`;
  eventBus.publish('warning', text);
  eventLog.value.push(`å‘å¸ƒè­¦å‘Š: ${text}`);
};

// å‘å¸ƒç¤ºä¾‹äº‹ä»¶
const publishEvent = () => {
  publishMessage();
};

// åˆå§‹æ·»åŠ ä¸¤ä¸ªè®¢é˜…è€…
onMounted(() => {
  addSubscriber();
  addSubscriber();
});
</script>

<style lang="less" scoped>
@primary-color: #4361ee;
@secondary-color: #3a0ca3;
@accent-color: #4895ef;
@info-color: #4cc9f0;
@warning-color: #ff9e00;
@success-color: #06d6a0;
@light-bg: #f8f9fa;
@card-bg: #ffffff;
@text-color: #2b2d42;
@border-color: #e9ecef;

.pub-sub-container {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: @text-color;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
  min-height: 100vh;
  padding: 2rem;
}

.header {
  text-align: center;
  margin-bottom: 2.5rem;
  padding: 2rem;
  background: linear-gradient(120deg, @primary-color, @secondary-color);
  border-radius: 16px;
  color: white;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);

  h1 {
    font-size: 2.8rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }

  p {
    font-size: 1.2rem;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto;
  }
}

.content {
  max-width: 1400px;
  margin: 0 auto;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.8rem;
  padding-bottom: 0.8rem;
  border-bottom: 2px solid @primary-color;

  .icon {
    font-size: 2rem;
    background: @primary-color;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  h2 {
    font-size: 1.8rem;
    color: @secondary-color;
  }
}

.concept-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.8rem;
  margin-bottom: 2.5rem;
}

.concept-card {
  background: @card-bg;
  border-radius: 16px;
  padding: 1.8rem;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.3s ease;

  &:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .concept-icon {
    font-size: 2.5rem;
    margin-bottom: 1.2rem;
    color: @primary-color;
  }

  h3 {
    color: @secondary-color;
    margin-bottom: 1rem;
    font-size: 1.4rem;
  }

  ul {
    padding-left: 1.2rem;

    li {
      padding: 0.5rem 0;
      border-bottom: 1px dashed @border-color;

      &:last-child {
        border-bottom: none;
      }
    }
  }
}

.implementation-steps {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2.5rem;
}

.step {
  display: flex;
  background: @card-bg;
  border-radius: 14px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);

  .step-number {
    width: 40px;
    height: 40px;
    background: @primary-color;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    margin-right: 1.2rem;
    flex-shrink: 0;
  }

  .step-content {
    h3 {
      color: @secondary-color;
      margin-bottom: 0.8rem;
      font-size: 1.3rem;
    }
  }
}

.structure-diagram {
  background: @card-bg;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.06);
  margin-top: 2rem;

  h3 {
    text-align: center;
    color: @secondary-color;
    margin-bottom: 1.5rem;
  }
}

.diagram {
  display: grid;
  grid-template-columns: 1fr 2fr 2fr;
  gap: 1.5rem;
  min-height: 400px;

  @media (max-width: 992px) {
    grid-template-columns: 1fr;
    min-height: auto;
  }
}

.publisher, .event-channel, .subscribers {
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
}

.publisher {
  background: fade(@info-color, 10%);
  border: 2px solid @info-color;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  .publish-btn {
    background: @info-color;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    margin-top: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
      background: darken(@info-color, 10%);
      transform: translateY(-2px);
    }
  }
}

.event-channel {
  background: fade(@primary-color, 10%);
  border: 2px solid @primary-color;

  .channel-header {
    text-align: center;
    font-weight: bold;
    color: @primary-color;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid @border-color;
  }
}

.events-list {
  height: 330px;
  overflow-y: auto;

  .event-item {
    background: white;
    border-radius: 6px;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
}

.subscribers {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
  overflow-y: auto;
}

.subscriber {
  background: fade(@success-color, 10%);
  border: 2px solid @success-color;
  border-radius: 10px;
  padding: 1rem;

  .messages {
    margin-top: 1rem;
    height: 120px;
    overflow-y: auto;

    .message {
      background: white;
      border-radius: 6px;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
  }
}

.code-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;

  button {
    padding: 0.8rem 1.5rem;
    background: @light-bg;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
      background: lighten(@primary-color, 40%);
    }

    &.active {
      background: @primary-color;
      color: white;
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
    }
  }
}

.code-content {
  background: #2b2d42;
  border-radius: 12px;
  overflow: hidden;

  h3 {
    color: white;
    padding: 1rem 1.5rem;
    background: #34374c;
    margin: 0;
    font-size: 1.2rem;
  }
}

pre {
  margin: 0;
  padding: 1.5rem;
  overflow-x: auto;

  code {
    font-family: 'Fira Code', monospace;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #f8f9fa;
  }
}

.demo-container {
  background: @card-bg;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.06);
}

.demo-controls {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 2rem;

  .publish-btn {
    background: @primary-color;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
      background: darken(@primary-color, 10%);
      transform: translateY(-2px);
    }
  }

  .subscribe-btn {
    background: @success-color;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
      background: darken(@success-color, 10%);
      transform: translateY(-2px);
    }
  }
}

.subscribers-demo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
}

.subscriber-card {
  background: @light-bg;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);

  .subscriber-header {
    background: @primary-color;
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .unsubscribe-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.3rem 0.8rem;
    font-size: 0.9rem;
    cursor: pointer;

    &:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  }
}

.messages-container {
  padding: 1rem;
  height: 200px;
  overflow-y: auto;

  .message {
    background: white;
    border-radius: 8px;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);

    &.message-warning {
      border-left: 4px solid @warning-color;
      background: fade(@warning-color, 10%);
    }
  }
}

@media (max-width: 768px) {
  .header {
    padding: 1.5rem;

    h1 {
      font-size: 2rem;
    }
  }

  .diagram {
    grid-template-columns: 1fr;

    .publisher, .event-channel, .subscribers {
      margin-bottom: 1.5rem;
    }
  }
}
</style>
