<template>
  <div class="async-container">
    <header class="header">
      <h1>JavaScript Async å‡½æ•°è¯¦è§£</h1>
      <div class="subtitle">ç”¨åŒæ­¥æ–¹å¼å†™å¼‚æ­¥ä»£ç çš„ç»ˆææ–¹æ¡ˆ</div>
    </header>

    <main class="content">
      <!-- åŸç†å›¾ç¤º -->
      <section class="card principle">
        <h2>âš™ï¸ è¿è¡ŒåŸç†</h2>
        <div class="principle-diagram">
          <div class="execution-flow">
            <div class="step">
              <div class="step-icon">1</div>
              <p>è°ƒç”¨ async å‡½æ•°</p>
            </div>
            <div class="arrow">â‡’</div>
            <div class="step">
              <div class="step-icon">2</div>
              <p>éšå¼è¿”å› Promise</p>
            </div>
            <div class="arrow">â‡’</div>
            <div class="step">
              <div class="step-icon">3</div>
              <p>è‡ªåŠ¨æ‰§è¡Œ Generator</p>
              <div class="sub-flow">
                <span class="await">é‡åˆ° await</span>
                <div class="arrow">â†“</div>
                <span class="pause">æš‚åœæ‰§è¡Œ</span>
                <div class="arrow">â†“</div>
                <span class="resume">å¼‚æ­¥å®Œæˆæ¢å¤</span>
              </div>
            </div>
          </div>
          <div class="principle-desc">
            <h3>æ ¸å¿ƒæœºåˆ¶ï¼š</h3>
            <ul>
              <li>â–¸ è¯­æ³•ç³–ï¼šåŸºäº Generator + Promise çš„å°è£…</li>
              <li>â–¸ è‡ªåŠ¨æ‰§è¡Œï¼šé€šè¿‡å†…ç½®æ‰§è¡Œå™¨è‡ªåŠ¨è¿­ä»£ Generator</li>
              <li>â–¸ å¾®ä»»åŠ¡è°ƒåº¦ï¼šawait åçš„ä»£ç ä¼šè¢«åŒ…è£…æˆå¾®ä»»åŠ¡</li>
              <li>â–¸ é”™è¯¯å†’æ³¡ï¼šè‡ªåŠ¨æ•è·å¼‚å¸¸å¹¶ reject Promise</li>
            </ul>
            <div>
              <h3>ä¼˜ç‚¹</h3>
              <ul>
                <li>â–¸ è¯­æ³•ç®€æ´ï¼Œæ˜“äºç†è§£</li>
                <li>â–¸ å¯è¯»æ€§å¼ºï¼Œä»£ç æ›´ç›´è§‚</li>
                <li>â–¸ é”™è¯¯å¤„ç†æ–¹ä¾¿ï¼Œæ˜“äºè°ƒè¯•:try catchç›´æ¥æ•è·å¼‚å¸¸</li>
              </ul>
            </div>
          </div>

        </div>
      </section>

      <!-- åŸºæœ¬ç”¨æ³• -->
      <section class="card usage">
        <h2>ğŸ“Œ åŸºæœ¬è¯­æ³•</h2>
        <div class="syntax-section">
          <pre class="code-block"><code>// å‡½æ•°å£°æ˜
async function fetchData() {
  try {
    const response = await fetch('/api');
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
  }
}

// ç®­å¤´å‡½æ•°
const getUser = async (userId) => {
  const user = await db.query(`SELECT * FROM users WHERE id = ${userId}`);
  return user;
};

// IIFE ç«‹å³æ‰§è¡Œ
(async () => {
  await initApp();
})();</code></pre>
        </div>
      </section>

      <!-- for await...of ç”¨æ³• -->
      <section class="card for-await-of">
        <h2>ğŸ”„ for await...of ç”¨æ³•</h2>
        <div class="syntax-section">
          <pre class="code-block"><code>async function processItems(items) {
      for await (const item of items) {
        console.log(item); // é€ä¸ªå¤„ç†å¼‚æ­¥æ“ä½œ
      }
    }</code></pre>
          <p>
            ä½¿ç”¨ for await...of å¯ä»¥ç®€åŒ–å¤„ç†å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡çš„ä»£ç ï¼Œé€‚ç”¨äºéœ€è¦é€ä¸ªå¤„ç†å¼‚æ­¥ç»“æœçš„åœºæ™¯ã€‚
          </p>
        </div>
      </section>

      <!-- for å¾ªç¯ä¸­ä½¿ç”¨ await -->
      <section class="card for-await-loop">
        <h2>ğŸ”„ for å¾ªç¯ä¸­ä½¿ç”¨ await</h2>
        <div class="syntax-section">
          <pre class="code-block"><code>async function processUrls(urls) {
      for (const url of urls) {
        const response = await fetch(url);
        const data = await response.json();
        console.log(data); // é€ä¸ªå¤„ç†æ¯ä¸ª URL çš„å“åº”
      }
    }</code></pre>
          <p>ä½¿ç”¨ for å¾ªç¯ç»“åˆ await å¯ä»¥é€ä¸ªå¤„ç†å¼‚æ­¥è¯·æ±‚ï¼Œé€‚ç”¨äºéœ€è¦é¡ºåºæ‰§è¡Œçš„åœºæ™¯ã€‚</p>
        </div>
      </section>

      <!-- ä½¿ç”¨åœºæ™¯ -->
      <section class="card use-cases">
        <h2>ğŸ’¡ å…¸å‹åº”ç”¨åœºæ™¯</h2>
        <div class="case-grid">
          <div class="case-card">
            <h3>1. é¡ºåºå¼‚æ­¥æ“ä½œ</h3>
            <pre><code>async function processOrder() {
  const user = await getUser();
  const cart = await getCart(user.id);
  const order = await createOrder(cart);
  await sendConfirmation(order);
}</code></pre>
          </div>

          <div class="case-card">
            <h3>2. å¹¶è¡Œå¼‚æ­¥æ“ä½œ</h3>
            <pre><code>async function loadData() {
  const [user, product] = await Promise.all([
    fetchUser(),
    fetchProduct()
  ]);
  return { user, product };
}</code></pre>
          </div>

          <div class="case-card">
            <h3>3. é”™è¯¯å¤„ç†</h3>
            <pre><code>async function safeFetch() {
  try {
    return await fetchData();
  } catch (err) {
    logError(err);
    return fallbackData;
  }
}</code></pre>
          </div>

          <div class="case-card">
            <h3>4. å¾ªç¯å¤„ç†</h3>
            <pre><code>async function processBatch(items) {
  for (const item of items) {
    await processItem(item); // é¡ºåºæ‰§è¡Œ
  }

  // å¹¶è¡Œç‰ˆæœ¬
  await Promise.all(items.map(processItem));
}</code></pre>
          </div>
        </div>
      </section>

      <!-- æ³¨æ„äº‹é¡¹ -->
      <section class="card pitfalls">
        <h2>âš ï¸ æ³¨æ„äº‹é¡¹</h2>
        <div class="warning-grid">
          <div class="warning">
            <h3>ä¸è¦å¿˜è®° await</h3>
            <p>é”™è¯¯ç¤ºä¾‹ï¼š</p>
            <pre><code>async function example() {
  const data = fetchData(); // ç¼ºå°‘ await
  return data; // è¿”å›çš„æ˜¯ Promise å¯¹è±¡
}</code></pre>
          </div>

          <div class="warning">
            <h3>åˆç†å¤„ç†å¹¶è¡Œ</h3>
            <pre><code>// ä½æ•ˆé¡ºåºæ‰§è¡Œ
await a();
await b();

// é«˜æ•ˆå¹¶è¡Œæ‰§è¡Œ
await Promise.all([a(), b()]);</code></pre>
          </div>

          <div class="warning">
            <h3>é¿å…é¡¶å±‚ await</h3>
            <pre><code>// æ¨¡å—é¡¶å±‚ (ES2022+)
await init(); // å¯èƒ½é€ æˆæ¨¡å—åŠ è½½é˜»å¡

// æ¨èåŒ…è£¹åœ¨ async IIFE ä¸­
(async () => {
  await init();
})();</code></pre>
          </div>

          <div class="warning">
            <h3>æ€§èƒ½é™·é˜±</h3>
            <pre><code>// å¾ªç¯ä¸­çš„ä¸²è¡Œ await
for (const url of urls) {
  await fetch(url); // é€ä¸ªè¯·æ±‚ï¼Œé€Ÿåº¦æ…¢
}

// æ‰¹é‡å¹¶è¡Œå¤„ç†
const promises = urls.map(url => fetch(url));
await Promise.all(promises);</code></pre>
          </div>
        </div>
      </section>

      <!-- å®ç°åŸç† -->
      <section class="card implementation">
        <h2>ğŸ”§ Promise + Generator å®ç° Async</h2>
        <div class="implementation-content">
          <p>async/await æœ¬è´¨ä¸Šæ˜¯ Generator + Promise çš„è¯­æ³•ç³–,ä¸‹é¢æ˜¯å…¶æ ¸å¿ƒå®ç°åŸç†:</p>
          <pre><code>function asyncToGenerator(generatorFunc) {
  // è¿”å›ä¸€ä¸ªåŒ…è£…å‡½æ•°
  return function(...args) {
    const gen = generatorFunc.apply(this, args);

    // è¿”å›Promise
    return new Promise((resolve, reject) => {
      function step(key, arg) {
        let genResult;
        try {
          genResult = gen[key](arg);
        } catch (error) {
          return reject(error);
        }

        const { value, done } = genResult;

        if (done) {
          // Generator æ‰§è¡Œå®Œæ¯•
          return resolve(value);
        } else {
          // ç¡®ä¿è¿”å›å€¼æ˜¯ Promise
          return Promise.resolve(value).then(
            val => step('next', val),
            err => step('throw', err)
          );
        }
      }

      step('next');
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const getData = asyncToGenerator(function* () {
  const data1 = yield fetch('url1');
  const data2 = yield fetch('url2');
  return data2;
});</code></pre>

          <div class="implementation-notes">
            <h3>å®ç°è¦ç‚¹:</h3>
            <ul>
              <li>å°† Generator å‡½æ•°åŒ…è£…æˆè¿”å› Promise çš„å‡½æ•°</li>
              <li>è‡ªåŠ¨æ‰§è¡Œ Generator ç›´åˆ°ç»“æŸ</li>
              <li>å¤„ç†ä¸­é—´å€¼,ç¡®ä¿æ˜¯ Promise</li>
              <li>é”™è¯¯ä¼ é€’å’Œå¼‚å¸¸å¤„ç†</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>
</template>

<style scoped>
li,
p,
h3,
h4 {
  color: rgb(0, 0, 0);
}

.async-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
  background: #f8f9fa;
  min-height: 100vh;
}

.header {
  text-align: center;
  margin-bottom: 3rem;
}

.header h1 {
  font-size: 2.5rem;
  color: #2c3e50;
  margin-bottom: 0.5rem;
}

.subtitle {
  font-size: 1.2rem;
  color: #7f8c8d;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
}

h2 {
  color: #2c3e50;
  border-bottom: 2px solid #3498db;
  padding-bottom: 0.5rem;
  margin-bottom: 1.5rem;
}

.principle-diagram {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
}

.execution-flow {
  background: #f4f6f8;
  padding: 2rem;
  border-radius: 8px;
}

.step {
  text-align: center;
  padding: 1rem;
  background: white;
  border-radius: 8px;
  margin: 1rem 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.step-icon {
  width: 30px;
  height: 30px;
  background: #3498db;
  color: white;
  border-radius: 50%;
  margin: 0 auto 0.5rem;
  line-height: 30px;
}

.arrow {
  font-size: 1.5rem;
  color: #7f8c8d;
  text-align: center;
  margin: 1rem 0;
}

.sub-flow {
  margin-top: 1rem;
  color: #e67e22;
}

.principle-desc ul {
  padding-left: 1.5rem;
  line-height: 1.8;
}

.principle-desc li {
  margin: 0.8rem 0;
}

.case-grid,
.warning-grid {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
}

.case-card,
.warning {
  background: #f8f9fa;
  padding: 1.2rem;
  border-radius: 8px;
  border-left: 4px solid #3498db;
}

.warning {
  border-color: #e74c3c;
}

.code-block {
  background: #2c3e50;
  color: white;
  padding: 1.5rem;
  border-radius: 8px;
  overflow-x: auto;
}

pre code {
  font-family: 'Fira Code', monospace;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .principle-diagram {
    grid-template-columns: 1fr;
  }

  .case-grid,
  .warning-grid {
    grid-template-columns: 1fr;
  }
}
</style>
