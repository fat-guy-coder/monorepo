<template>
  <div class="memory-management-guide">
    <header>
      <h1>æµè§ˆå™¨å†…å­˜ç®¡ç†æŒ‡å—</h1>
      <p>æ·±å…¥ç†è§£å†…å­˜åˆ†é…ã€ä½¿ç”¨ä¸å›æ”¶æœºåˆ¶</p>
    </header>

    <main>
      <!-- å†…å­˜ç®¡ç†æ¦‚è¿° -->
      <section class="overview">
        <div class="memory-model">
          <h2>æµè§ˆå™¨å†…å­˜æ¨¡å‹</h2>
          <div class="model-diagram">
            <div class="memory-stack">
              <div class="section-header">è°ƒç”¨æ ˆ (Stack)</div>
              <div class="stack-content">
                <div class="frame">å‡½æ•°å¸§3</div>
                <div class="frame">å‡½æ•°å¸§2</div>
                <div class="frame">å‡½æ•°å¸§1</div>
                <div class="frame">å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡</div>
              </div>
              <div class="properties">
                <div class="property">å›ºå®šå¤§å°</div>
                <div class="property">è‡ªåŠ¨åˆ†é…/é‡Šæ”¾</div>
                <div class="property">å­˜å‚¨åŸºæœ¬ç±»å‹å’Œå¼•ç”¨åœ°å€</div>
              </div>
            </div>
            <div class="memory-heap">
              <div class="section-header">å †å†…å­˜ (Heap)</div>
              <div class="heap-content">
                <div class="generation">
                  <div class="gen-label">æ–°ç”Ÿä»£</div>
                  <div class="objects">
                    <div class="object" v-for="i in 8" :key="'n' + i"></div>
                  </div>
                </div>
                <div class="generation">
                  <div class="gen-label">è€ç”Ÿä»£</div>
                  <div class="objects">
                    <div class="object" v-for="i in 16" :key="'o' + i"></div>
                  </div>
                </div>
              </div>
              <div class="properties">
                <div class="property">åŠ¨æ€åˆ†é…</div>
                <div class="property">å­˜å‚¨å¼•ç”¨ç±»å‹</div>
                <div class="property">åƒåœ¾å›æ”¶ç®¡ç†</div>
              </div>
            </div>
          </div>
        </div>

        <div class="memory-lifecycle">
          <h2>å†…å­˜ç”Ÿå‘½å‘¨æœŸ</h2>
          <div class="lifecycle-steps">
            <div class="step">
              <div class="step-icon">1</div>
              <h3>åˆ†é…å†…å­˜</h3>
              <p>å£°æ˜å˜é‡ã€åˆ›å»ºå¯¹è±¡æˆ–å‡½æ•°æ—¶åˆ†é…å†…å­˜</p>
            </div>
            <div class="arrow">â†’</div>
            <div class="step">
              <div class="step-icon">2</div>
              <h3>ä½¿ç”¨å†…å­˜</h3>
              <p>è¯»å†™å†…å­˜ä¸­çš„å€¼</p>
            </div>
            <div class="arrow">â†’</div>
            <div class="step">
              <div class="step-icon">3</div>
              <h3>é‡Šæ”¾å†…å­˜</h3>
              <p>åƒåœ¾å›æ”¶å™¨è‡ªåŠ¨å›æ”¶ä¸å†ä½¿ç”¨çš„å†…å­˜</p>
            </div>
          </div>
        </div>
      </section>

      <!-- å†…å­˜åˆ†é…ç­–ç•¥ -->
      <section class="allocation">
        <h2>å†…å­˜åˆ†é…ç­–ç•¥</h2>
        <div class="strategies">
          <div class="strategy">
            <div class="strategy-icon">ğŸ“¦</div>
            <h3>æ ˆå†…å­˜åˆ†é…</h3>
            <p>ç”¨äºå­˜å‚¨åŸå§‹ç±»å‹å’Œå‡½æ•°è°ƒç”¨å¸§</p>
            <pre><code>function calculate() {
  const a = 5;      // æ ˆåˆ†é…
  const b = 10;     // æ ˆåˆ†é…
  return a + b;     // æ ˆæ“ä½œ
}</code></pre>
          </div>

          <div class="strategy">
            <div class="strategy-icon">ğŸ—„ï¸</div>
            <h3>å †å†…å­˜åˆ†é…</h3>
            <p>ç”¨äºå­˜å‚¨å¯¹è±¡ã€æ•°ç»„ç­‰å¼•ç”¨ç±»å‹</p>
            <pre><code>// å †åˆ†é…
const user = {
  name: 'Alice',
  age: 30
};

// å †åˆ†é…
const scores = [95, 89, 78];</code></pre>
          </div>

          <div class="strategy">
            <div class="strategy-icon">ğŸ§ </div>
            <h3>å†…å­˜æ± ç®¡ç†</h3>
            <p>é«˜æ•ˆç®¡ç†å¤§é‡å°å¯¹è±¡</p>
            <pre><code>class ObjectPool {
  constructor(createFn) {
    this.createFn = createFn;
    this.pool = [];
  }

  get() {
    return this.pool.length ?
      this.pool.pop() : this.createFn();
  }

  release(obj) {
    this.pool.push(obj);
  }
}</code></pre>
          </div>
        </div>
      </section>

      <!-- å†…å­˜ä¼˜åŒ–æŠ€æœ¯ -->
      <section class="optimization">
        <h2>å†…å­˜ä¼˜åŒ–æŠ€æœ¯</h2>
        <div class="techniques">
          <div class="technique">
            <h3>1. å‡å°‘å†…å­˜åˆ†é…</h3>
            <ul>
              <li>é¿å…ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º</li>
              <li>é‡ç”¨å¯¹è±¡è€Œä¸æ˜¯åˆ›å»ºæ–°å®ä¾‹</li>
              <li>ä½¿ç”¨åŸºæœ¬ç±»å‹ä»£æ›¿å¯¹è±¡</li>
            </ul>
            <div class="code-comparison">
              <div>
                <p class="bad">ä¸æ¨è</p>
                <pre><code>function logName(user) {
  const name = user.name; // ä¸å¿…è¦çš„å­—ç¬¦ä¸²åˆ†é…
  console.log(name);
}</code></pre>
              </div>
              <div>
                <p class="good">æ¨è</p>
                <pre><code>function logName(user) {
  console.log(user.name); // ç›´æ¥è®¿é—®å±æ€§
}</code></pre>
              </div>
            </div>
          </div>

          <div class="technique">
            <h3>2. åŠæ—¶é‡Šæ”¾å¼•ç”¨</h3>
            <ul>
              <li>åœ¨ä¸å†éœ€è¦æ—¶è§£é™¤å¯¹è±¡å¼•ç”¨</li>
              <li>é¿å…å…¨å±€å˜é‡é•¿æœŸæŒæœ‰å¯¹è±¡</li>
              <li>æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨</li>
            </ul>
            <pre><code>// ç»„ä»¶å¸è½½æ—¶æ¸…ç†èµ„æº
onUnmounted(() => {
  // æ¸…é™¤å®šæ—¶å™¨
  clearInterval(timer);

  // ç§»é™¤äº‹ä»¶ç›‘å¬
  window.removeEventListener('resize', handleResize);

  // é‡Šæ”¾å¤§å¯¹è±¡å¼•ç”¨
  largeData = null;
});</code></pre>
          </div>

          <div class="technique">
            <h3>3. ä½¿ç”¨å¼±å¼•ç”¨</h3>
            <ul>
              <li>WeakMap å’Œ WeakSet ä¸é˜»æ­¢åƒåœ¾å›æ”¶</li>
              <li>é€‚ç”¨äºç¼“å­˜å’Œå…ƒæ•°æ®å­˜å‚¨</li>
              <li>é¿å…æ„å¤–å†…å­˜æ³„æ¼</li>
            </ul>
            <pre><code>// ä½¿ç”¨ WeakMap å­˜å‚¨å…ƒæ•°æ®
const metadata = new WeakMap();

function setMetadata(obj, data) {
  metadata.set(obj, data);
  // å½“objä¸å†è¢«å¼•ç”¨æ—¶ï¼Œdataä¼šè‡ªåŠ¨å›æ”¶
}</code></pre>
          </div>
        </div>
      </section>

      <!-- å†…å­˜åˆ†æå·¥å…· -->
      <section class="tools">
        <h2>å†…å­˜åˆ†æå·¥å…·</h2>
        <div class="tool-grid">
          <div class="tool">
            <div class="tool-icon">ğŸ“Š</div>
            <h3>Chrome DevTools</h3>
            <ul>
              <li><strong>Performance é¢æ¿</strong>ï¼šåˆ†æå†…å­˜ä½¿ç”¨æ—¶é—´çº¿</li>
              <li><strong>Memory é¢æ¿</strong>ï¼šæ‹æ‘„å †å¿«ç…§åˆ†æå†…å­˜åˆ†é…</li>
              <li><strong>Performance Monitor</strong>ï¼šå®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨</li>
            </ul>
          </div>

          <div class="tool">
            <div class="tool-icon">âš™ï¸</div>
            <h3>å†…å­˜åˆ†æAPI</h3>
            <pre><code>// ç›‘æ§å†…å­˜ä½¿ç”¨
function monitorMemory() {
  const memory = performance.memory;

  return {
    used: `${(memory.usedJSHeapSize / 1048576).toFixed(2)} MB`,
    total: `${(memory.totalJSHeapSize / 1048576).toFixed(2)} MB`,
    limit: `${(memory.jsHeapSizeLimit / 1048576).toFixed(2)} MB`
  };
}

// æ¯5ç§’è®°å½•å†…å­˜ä½¿ç”¨
setInterval(() => {
  console.table(monitorMemory());
}, 5000);</code></pre>
          </div>

          <div class="tool">
            <div class="tool-icon">ğŸ”</div>
            <h3>å†…å­˜åˆ†ææµç¨‹</h3>
            <ol>
              <li>è®°å½•åˆå§‹å†…å­˜å¿«ç…§</li>
              <li>æ‰§è¡Œç‰¹å®šæ“ä½œ</li>
              <li>è®°å½•æ“ä½œåå†…å­˜å¿«ç…§</li>
              <li>æ¯”è¾ƒå¿«ç…§ï¼Œè¯†åˆ«å†…å­˜å¢é•¿</li>
              <li>åˆ†æä¿ç•™è·¯å¾„ï¼ŒæŸ¥æ‰¾æ³„æ¼æº</li>
            </ol>
          </div>
        </div>
      </section>

      <!-- æœ€ä½³å®è·µ -->
      <section class="best-practices">
        <h2>å†…å­˜ç®¡ç†æœ€ä½³å®è·µ</h2>
        <div class="practices">
          <div class="practice">
            <div class="number">1</div>
            <div>
              <h3>é¿å…å…¨å±€å˜é‡</h3>
              <p>å…¨å±€å˜é‡ä¼šä¸€ç›´å­˜åœ¨ç›´åˆ°é¡µé¢å…³é—­ï¼Œå¯èƒ½æŒæœ‰ä¸éœ€è¦çš„å¼•ç”¨</p>
            </div>
          </div>

          <div class="practice">
            <div class="number">2</div>
            <div>
              <h3>ä½¿ç”¨å¯¹è±¡æ± </h3>
              <p>å¯¹äºé¢‘ç¹åˆ›å»ºé”€æ¯çš„å¯¹è±¡ï¼Œä½¿ç”¨æ± åŒ–æŠ€æœ¯å‡å°‘GCå‹åŠ›</p>
            </div>
          </div>

          <div class="practice">
            <div class="number">3</div>
            <div>
              <h3>ä¼˜åŒ–æ•°æ®ç»“æ„</h3>
              <p>é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„å‡å°‘å†…å­˜å ç”¨</p>
            </div>
          </div>

          <div class="practice">
            <div class="number">4</div>
            <div>
              <h3>åˆ†æ‰¹å¤„ç†å¤§æ•°æ®</h3>
              <p>é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤„ç†å¤§é‡æ•°æ®</p>
            </div>
          </div>

          <div class="practice">
            <div class="number">5</div>
            <div>
              <h3>ä½¿ç”¨Web Workers</h3>
              <p>å°†å†…å­˜å¯†é›†å‹ä»»åŠ¡ç§»åˆ°ç‹¬ç«‹çº¿ç¨‹</p>
            </div>
          </div>

          <div class="practice">
            <div class="number">6</div>
            <div>
              <h3>å®šæœŸæ€§èƒ½åˆ†æ</h3>
              <p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­æŒç»­ç›‘æ§å†…å­˜ä½¿ç”¨</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>Â© 2023 æµè§ˆå™¨å†…å­˜ç®¡ç†æŒ‡å— | ä½¿ç”¨Vue3å’ŒTypeScriptå®ç°</p>
    </footer>
  </div>
</template>

<script setup lang="ts">
// è¿™é‡Œå¯ä»¥æ·»åŠ å†…å­˜ç›‘æ§é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
</script>

<style lang="less" scoped>
@primary: #4361ee;
@secondary: #3a0ca3;
@accent: #4cc9f0;
@stack-color: #ff9e00;
@heap-color: #7209b7;
@light: #f8f9fa;
@dark: #212529;
@good: #2ec4b6;
@bad: #e71d36;

// åŸºç¡€æ ·å¼
.memory-management-guide {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
  font-family: 'Segoe UI', system-ui, sans-serif;
  color: @dark;
  line-height: 1.6;

  header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: @secondary;
      background: linear-gradient(135deg, @secondary, @primary);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    p {
      color: lighten(@dark, 20%);
      font-size: 1.1rem;
    }
  }

  section {
    margin-bottom: 3rem;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);

    h2 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid @accent;
      color: @secondary;
    }
  }
}

// å†…å­˜æ¨¡å‹éƒ¨åˆ†
.overview {
  display: grid;
  grid-template-columns: 1fr;
  gap: 2rem;

  @media (min-width: 992px) {
    grid-template-columns: 1fr 1fr;
  }

  .memory-model,
  .memory-lifecycle {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
  }
}

.model-diagram {
  display: flex;
  flex-direction: column;
  gap: 2rem;

  .memory-stack,
  .memory-heap {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .section-header {
    background: linear-gradient(to right, @primary, @secondary);
    color: white;
    padding: 0.8rem;
    font-weight: 600;
    text-align: center;
  }

  .memory-stack {
    background: lighten(@stack-color, 40%);
    border: 1px solid @stack-color;

    .stack-content {
      padding: 1rem;
    }

    .frame {
      background: lighten(@stack-color, 30%);
      border: 1px solid @stack-color;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
    }
  }

  .memory-heap {
    background: lighten(@heap-color, 55%);
    border: 1px solid @heap-color;

    .heap-content {
      padding: 1rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .generation {
      padding: 1rem;
      border-radius: 6px;

      &:first-child {
        background: lighten(@good, 40%);
        border: 1px solid @good;
      }

      &:last-child {
        background: lighten(@accent, 30%);
        border: 1px solid @accent;
      }
    }

    .gen-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .objects {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;

      .object {
        height: 25px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
    }
  }

  .properties {
    display: flex;
    background: rgba(0, 0, 0, 0.03);
    padding: 0.8rem;
    border-top: 1px solid rgba(0, 0, 0, 0.05);

    .property {
      flex: 1;
      text-align: center;
      font-size: 0.9rem;
      padding: 0.3rem;
    }
  }
}

.memory-lifecycle {
  .lifecycle-steps {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1.5rem;

    @media (min-width: 768px) {
      flex-direction: row;
      justify-content: space-between;
    }

    .arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: @primary;
      padding: 0 1rem;

      @media (max-width: 767px) {
        transform: rotate(90deg);
        padding: 0;
        margin: -0.5rem 0;
      }
    }
  }

  .step {
    text-align: center;
    flex: 1;

    .step-icon {
      width: 60px;
      height: 60px;
      background: @primary;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      margin: 0 auto 1rem;
    }

    h3 {
      color: @secondary;
      margin: 0 0 0.5rem;
    }

    p {
      color: lighten(@dark, 20%);
      margin: 0;
    }
  }
}

// å†…å­˜åˆ†é…ç­–ç•¥
.allocation {
  .strategies {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  .strategy {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;

    .strategy-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    h3 {
      color: @secondary;
      margin: 0.5rem 0;
    }

    p {
      color: lighten(@dark, 20%);
      margin-bottom: 1rem;
    }

    pre {
      background: #2d3748;
      border-radius: 6px;
      padding: 1rem;
      overflow: auto;
      margin: 0;
      text-align: left;

      code {
        font-family: 'Fira Code', monospace;
        color: #cbd5e0;
        font-size: 0.85rem;
        line-height: 1.4;
      }
    }
  }
}

// å†…å­˜ä¼˜åŒ–æŠ€æœ¯
.optimization {
  .techniques {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;

    @media (min-width: 992px) {
      grid-template-columns: repeat(2, 1fr);

      .technique:last-child {
        grid-column: span 2;
      }
    }
  }

  .technique {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;

    h3 {
      color: @secondary;
      margin-top: 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e9ecef;
    }

    ul {
      padding-left: 1.2rem;
      margin: 1rem 0;

      li {
        margin-bottom: 0.5rem;
        position: relative;
        padding-left: 1.5rem;

        &::before {
          content: "â€¢";
          color: @primary;
          position: absolute;
          left: 0;
          font-size: 1.2rem;
          line-height: 1;
        }
      }
    }

    pre {
      background: #2d3748;
      border-radius: 6px;
      padding: 1rem;
      overflow: auto;

      code {
        font-family: 'Fira Code', monospace;
        color: #cbd5e0;
        font-size: 0.85rem;
        line-height: 1.4;
      }
    }
  }

  .code-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;

    .bad,
    .good {
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-align: center;
      padding: 0.3rem;
      border-radius: 4px;
    }

    .bad {
      background: lighten(@bad, 40%);
      color: darken(@bad, 20%);
    }

    .good {
      background: lighten(@good, 40%);
      color: darken(@good, 20%);
    }
  }
}

// å·¥å…·éƒ¨åˆ†
.tools {
  .tool-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .tool {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;

    .tool-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    h3 {
      color: @secondary;
      margin-top: 0;
      text-align: center;
    }

    ul,
    ol {
      padding-left: 1.2rem;
      margin: 0.5rem 0 0;

      li {
        margin-bottom: 0.5rem;
      }
    }

    ol {
      counter-reset: item;
      padding-left: 0;

      li {
        counter-increment: item;
        margin-bottom: 1rem;
        position: relative;
        padding-left: 2rem;

        &::before {
          content: counter(item);
          position: absolute;
          left: 0;
          top: 0;
          width: 24px;
          height: 24px;
          background: @primary;
          color: rgba(255, 255, 255, 0.5);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.8rem;
          font-weight: bold;
        }
      }
    }

    pre {
      background: #2d3748;
      border-radius: 6px;
      padding: 1rem;
      overflow: auto;
      margin-top: 1rem;

      code {
        font-family: 'Fira Code', monospace;
        color: #cbd5e0;
        font-size: 0.85rem;
        line-height: 1.4;
      }
    }
  }
}

// æœ€ä½³å®è·µ
.best-practices {
  .practices {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .practice {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    border-left: 4px solid @primary;

    .number {
      width: 36px;
      height: 36px;
      background: @primary;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
      font-size: 1.1rem;
    }

    h3 {
      color: @secondary;
      margin: 0 0 0.5rem;
    }

    p {
      color: lighten(@dark, 20%);
      margin: 0;
    }
  }
}

// é¡µè„š
footer {
  text-align: center;
  margin-top: 3rem;
  padding-top: 2rem;
  color: lighten(@dark, 30%);
  font-size: 0.9rem;
  border-top: 1px solid #e9ecef;
}
</style>
