<template>
  <div class="lru-container">
    <div class="header">
      <h1>LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜ç®—æ³•</h1>
      <p class="subtitle">ä¸€ç§é«˜æ•ˆçš„å†…å­˜ç®¡ç†ç­–ç•¥</p>
    </div>

    <div class="content-wrapper">
      <div class="algorithm-section">
        <div class="section">
          <h2>ç®—æ³•ä»‹ç»</h2>
          <div class="card">
            <p>
              LRU (Least Recently Used)
              æ˜¯ä¸€ç§ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡¹ç›®ä»¥è…¾å‡ºç©ºé—´ç»™æ–°é¡¹ç›®ã€‚
            </p>
            <p>
              æ ¸å¿ƒæ€æƒ³ï¼šå¦‚æœä¸€ä¸ªæ•°æ®åœ¨æœ€è¿‘ä¸€æ®µæ—¶é—´æ²¡æœ‰è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆåœ¨å°†æ¥å®ƒè¢«è®¿é—®çš„å¯èƒ½æ€§ä¹Ÿå¾ˆå°ã€‚
            </p>
            <div class="features">
              <div class="feature-item">
                <div class="feature-icon">ğŸ“Œ</div>
                <h3>åº”ç”¨åœºæ™¯</h3>
                <p>æµè§ˆå™¨ç¼“å­˜ã€æ•°æ®åº“ç¼“å­˜ã€æ“ä½œç³»ç»Ÿé¡µé¢ç½®æ¢ã€Rediså†…å­˜ç®¡ç†ç­‰</p>
              </div>
              <div class="feature-item">
                <div class="feature-icon">âš™ï¸</div>
                <h3>æ—¶é—´æ•ˆç‡</h3>
                <p>æ’å…¥å’Œè®¿é—®æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸º O(1)</p>
              </div>
              <div class="feature-item">
                <div class="feature-icon">ğŸ“</div>
                <h3>ç©ºé—´æ•ˆç‡</h3>
                <p>ç©ºé—´å¤æ‚åº¦ä¸º O(n)ï¼Œnä¸ºç¼“å­˜å®¹é‡</p>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>å®ç°æ€è·¯</h2>
          <div class="card">
            <div class="implementation-points">
              <div class="point">
                <div class="point-number">1</div>
                <p>ä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤ç¼“å­˜é¡¹çš„è®¿é—®é¡ºåºï¼š</p>
                <ul>
                  <li>æœ€è¿‘è®¿é—®çš„èŠ‚ç‚¹ç½®äºé“¾è¡¨å¤´éƒ¨</li>
                  <li>æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„èŠ‚ç‚¹ä½äºé“¾è¡¨å°¾éƒ¨</li>
                </ul>
              </div>
              <div class="point">
                <div class="point-number">2</div>
                <p>ä½¿ç”¨å“ˆå¸Œè¡¨æä¾› O(1) æ—¶é—´å¤æ‚åº¦çš„æŸ¥æ‰¾ï¼š</p>
                <ul>
                  <li>é”®æ˜ å°„åˆ°é“¾è¡¨ä¸­çš„èŠ‚ç‚¹</li>
                  <li>å¿«é€Ÿå®šä½èŠ‚ç‚¹ä½ç½®</li>
                </ul>
              </div>
              <div class="point">
                <div class="point-number">3</div>
                <p>æ ¸å¿ƒæ“ä½œï¼š</p>
                <ul>
                  <li><strong>è®¿é—®(get)</strong>ï¼šå°†èŠ‚ç‚¹ç§»è‡³é“¾è¡¨å¤´éƒ¨</li>
                  <li><strong>æ·»åŠ (put)</strong>ï¼šè‹¥å­˜åœ¨åˆ™æ›´æ–°å¹¶ç§»è‡³å¤´éƒ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°èŠ‚ç‚¹</li>
                  <li><strong>æ·˜æ±°</strong>ï¼šå½“ç¼“å­˜æ»¡æ—¶ï¼Œç§»é™¤é“¾è¡¨å°¾éƒ¨èŠ‚ç‚¹</li>
                </ul>
              </div>
              <div class="point">
                <div class="point-number">4</div>
                <p>æ•°æ®ç»“æ„å…³ç³»å›¾ï¼š</p>
                <div class="diagram">
                  <div class="hash-table">
                    <div class="hash-title">HashMap</div>
                    <div class="hash-row">
                      <div class="hash-key">Key1</div>
                      <div class="hash-arrow">â†’</div>
                      <div class="hash-value">Node1</div>
                    </div>
                    <div class="hash-row">
                      <div class="hash-key">Key2</div>
                      <div class="hash-arrow">â†’</div>
                      <div class="hash-value">Node2</div>
                    </div>
                    <div class="hash-row">
                      <div class="hash-key">...</div>
                      <div class="hash-arrow">â†’</div>
                      <div class="hash-value">...</div>
                    </div>
                  </div>
                  <div class="linked-list">
                    <div class="node head-node">
                      <div class="node-header">Head</div>
                    </div>
                    <div class="node">
                      <div class="node-header">Node1 (æœ€è¿‘ä½¿ç”¨)</div>
                      <div class="node-content">Key: Key1<br />Value: Value1</div>
                    </div>
                    <div class="node">
                      <div class="node-header">Node2</div>
                      <div class="node-content">Key: Key2<br />Value: Value2</div>
                    </div>
                    <div class="node tail-node">
                      <div class="node-header">Tail (æœ€è¿‘æœ€å°‘ä½¿ç”¨)</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>JavaScript å®ç°ä»£ç </h2>
          <div class="card">
            <pre class="code-block"><code>class LRUCache {
  constructor(capacity) {
    this.capacity = capacity;
    this.cache = new Map();
  }

  get(key) {
    if (!this.cache.has(key)) return -1;

    // æ›´æ–°è®°å½•ä¸ºæœ€è¿‘ä½¿ç”¨
    const value = this.cache.get(key);
    this.cache.delete(key);
    this.cache.set(key, value);

    return value;
  }

  put(key, value) {
    if (this.cache.has(key)) {
      this.cache.delete(key); // åˆ é™¤æ—§å€¼
    } else if (this.cache.size >= this.capacity) {
      // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„è®°å½•ï¼ˆMapç¬¬ä¸€ä¸ªé”®ï¼‰
      const oldestKey = this.cache.keys().next().value;
      this.cache.delete(oldestKey);
    }
    this.cache.set(key, value); // æ·»åŠ æ–°è®°å½•
  }

  // è·å–å½“å‰ç¼“å­˜å†…å®¹ï¼ˆç”¨äºå±•ç¤ºï¼‰
  getEntries() {
    return Array.from(this.cache.entries()).reverse();
  }
}</code></pre>
          </div>
        </div>
      </div>

      <div class="visualization-section">
        <h2>LRU å¯è§†åŒ–äº¤äº’æ¼”ç¤º</h2>
        <div class="demo-card">
          <div class="cache-controls">
            <div class="control-group">
              <label for="capacity">ç¼“å­˜å®¹é‡ï¼š</label>
              <input
                type="number"
                id="capacity"
                v-model.number="cacheCapacity"
                min="2"
                max="10"
                @change="resetCache"
              />
            </div>
            <div class="control-group">
              <label for="key">é”®ï¼š</label>
              <input type="text" id="key" v-model.trim="newKey" placeholder="è¾“å…¥é”®..." />
            </div>
            <div class="control-group">
              <label for="value">å€¼ï¼š</label>
              <input type="text" id="value" v-model.trim="newValue" placeholder="è¾“å…¥å€¼..." />
            </div>
            <div class="button-group">
              <button class="btn put-btn" @click="putItem">æ·»åŠ ç¼“å­˜ (PUT)</button>
              <button class="btn get-btn" @click="getItem">è·å–ç¼“å­˜ (GET)</button>
              <button class="btn reset-btn" @click="resetCache">é‡ç½®ç¼“å­˜</button>
            </div>
          </div>

          <div class="cache-status">
            <div class="status-item">
              <span class="status-label">å½“å‰å¤§å°ï¼š</span>
              <span class="status-value">{{ cacheSize }} / {{ cacheCapacity }}</span>
            </div>
            <div class="status-item">
              <span class="status-label">æ“ä½œç»“æœï¼š</span>
              <span class="status-value">{{ operationResult || '-' }}</span>
            </div>
          </div>

          <div class="cache-display">
            <div class="cache-header">
              <div class="cache-title">ç¼“å­˜å†…å®¹ (æœ€è¿‘ä½¿ç”¨ â†’ æœ€è¿‘æœ€å°‘ä½¿ç”¨)</div>
            </div>
            <div class="cache-items-wrapper">
              <div
                v-for="(item, index) in cacheEntries"
                :key="index"
                class="cache-item"
                :class="{
                  'new-item': item.isNew,
                  'accessed-item': item.isAccessed,
                }"
              >
                <div class="item-header">
                  <span class="item-key">{{ item.key }}</span>
                  <span class="item-timestamp">{{ item.timestamp }}</span>
                </div>
                <div class="item-value">{{ item.value }}</div>
              </div>
              <div v-if="cacheEntries.length === 0" class="empty-cache">
                ç¼“å­˜ä¸ºç©ºï¼Œè¯·æ·»åŠ é¡¹ç›®...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'

class LRUCache {
  capacity: number
  cache: Map<string, any>

  constructor(capacity: number) {
    this.capacity = capacity
    this.cache = new Map()
  }

  get(key: string): any {
    if (!this.cache.has(key)) return -1

    // æ›´æ–°è®°å½•ä¸ºæœ€è¿‘ä½¿ç”¨
    const value = this.cache.get(key)
    this.cache.delete(key)
    this.cache.set(key, value)

    return value
  }

  put(key: string, value: any): void {
    if (this.cache.has(key)) {
      this.cache.delete(key) // åˆ é™¤æ—§å€¼
    } else if (this.cache.size >= this.capacity) {
      // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„è®°å½•ï¼ˆMapç¬¬ä¸€ä¸ªé”®ï¼‰
      const oldestKey = this.cache.keys().next().value
      this.cache.delete(oldestKey as string)
    }
    this.cache.set(key, value) // æ·»åŠ æ–°è®°å½•
  }

  // è·å–å½“å‰ç¼“å­˜å†…å®¹ï¼ˆç”¨äºå±•ç¤ºï¼‰
  getEntries(): any[] {
    return Array.from(this.cache.entries())
      .map(([key, value]) => ({
        key,
        value,
        timestamp: new Date().toLocaleTimeString(),
      }))
      .reverse()
  }
}

// å“åº”å¼æ•°æ®
const cacheCapacity = ref(4)
const newKey = ref('')
const newValue = ref('')
const operationResult = ref('')
const lruCache = ref<LRUCache | null>(null)
const lastOperation = ref({ type: '', key: '' })

// åˆå§‹åŒ–ç¼“å­˜
const initCache = () => {
  lruCache.value = new LRUCache(cacheCapacity.value)
}

// é‡ç½®ç¼“å­˜
const resetCache = () => {
  initCache()
  lastOperation.value = { type: '', key: '' }
  operationResult.value = 'ç¼“å­˜å·²é‡ç½®'
  setTimeout(() => (operationResult.value = ''), 2000)
}

// è·å–å½“å‰ç¼“å­˜å¤§å°
const cacheSize = computed(() => {
  return lruCache.value ? lruCache.value.cache.size : 0
})

// è·å–ç¼“å­˜æ¡ç›®ï¼ˆå¸¦æ ‡è®°ï¼‰
const cacheEntries = computed(() => {
  if (!lruCache.value) return []

  const entries: any[] = lruCache.value.getEntries()

  // æ ‡è®°æ–°å¢å’Œè®¿é—®çš„é¡¹ç›®
  return entries.map((entry) => {
    return {
      ...entry,
      isNew: lastOperation.value.type === 'put' && lastOperation.value.key === entry.key,
      isAccessed: lastOperation.value.type === 'get' && lastOperation.value.key === entry.key,
    }
  })
})

// æ·»åŠ é¡¹ç›®åˆ°ç¼“å­˜
const putItem = () => {
  if (!newKey.value || !newValue.value) {
    operationResult.value = 'é”®å’Œå€¼ä¸èƒ½ä¸ºç©º'
    return
  }

  if (!lruCache.value) initCache()

  const existed = lruCache.value!.cache.has(newKey.value)
  lruCache.value!.put(newKey.value, newValue.value)

  lastOperation.value = { type: 'put', key: newKey.value }
  operationResult.value = existed
    ? `æ›´æ–°é”® "${newKey.value}" çš„å€¼ä¸º "${newValue.value}"`
    : `æ·»åŠ æ–°é”® "${newKey.value}" å€¼ä¸º "${newValue.value}"`

  // æ¸…ç©ºè¾“å…¥
  newKey.value = ''
  newValue.value = ''
}

// ä»ç¼“å­˜è·å–é¡¹ç›®
const getItem = () => {
  if (!newKey.value) {
    operationResult.value = 'è¯·è¾“å…¥è¦è·å–çš„é”®'
    return
  }

  if (!lruCache.value) {
    operationResult.value = 'ç¼“å­˜æœªåˆå§‹åŒ–'
    return
  }

  const value = lruCache.value.get(newKey.value)

  if (value === -1) {
    operationResult.value = `é”® "${newKey.value}" ä¸å­˜åœ¨`
  } else {
    lastOperation.value = { type: 'get', key: newKey.value }
    operationResult.value = `è·å–é”® "${newKey.value}" çš„å€¼ä¸º "${value}"`
  }

  newKey.value = ''
}

// åˆå§‹åŒ–
onMounted(initCache)
</script>

<style lang="less" scoped>
// é¢œè‰²å˜é‡
@primary-color: #4361ee;
@secondary-color: #3f37c9;
@accent-color: #4cc9f0;
@success-color: #4ade80;
@warning-color: #facc15;
@danger-color: #f87171;
@light-bg: #f8fafc;
@card-bg: #ffffff;
@text-color: #334155;
@border-color: #e2e8f0;
@shadow:
  0 4px 6px -1px rgba(0, 0, 0, 0.1),
  0 2px 4px -1px rgba(0, 0, 0, 0.06);

.lru-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  font-family:
    'Inter',
    -apple-system,
    BlinkMacSystemFont,
    'Segoe UI',
    Roboto,
    sans-serif;
  color: @text-color;
  background-color: @light-bg;
  min-height: 100vh;
}

.header {
  text-align: center;
  margin-bottom: 32px;

  h1 {
    font-size: 2.5rem;
    font-weight: 600;
    color: @primary-color;
    margin-bottom: 8px;
  }

  .subtitle {
    font-size: 1.1rem;
    color: lighten(@text-color, 20%);
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.6;
  }
}

.content-wrapper {
  display: grid;
  grid-template-columns: 1fr;
  gap: 24px;

  @media (max-width: 1100px) {
    grid-template-columns: 1fr;
  }
}

.section {
  margin-bottom: 32px;

  h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: @secondary-color;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid @accent-color;
  }
}

.card {
  background: @card-bg;
  border-radius: 12px;
  box-shadow: @shadow;
  padding: 24px;
  transition: transform 0.2s ease;

  &:hover {
    transform: translateY(-2px);
  }

  p {
    line-height: 1.7;
    margin-bottom: 16px;
  }
}

.features {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

.feature-item {
  background: lighten(@light-bg, 1%);
  border-radius: 8px;
  padding: 16px;
  border: 1px solid @border-color;

  .feature-icon {
    font-size: 2rem;
    margin-bottom: 12px;
  }

  h3 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: @primary-color;
  }

  p {
    font-size: 0.95rem;
    margin-bottom: 0;
    color: lighten(@text-color, 10%);
  }
}

.implementation-points {
  .point {
    display: flex;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px dashed @border-color;

    &:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
  }

  .point-number {
    width: 36px;
    height: 36px;
    background: @primary-color;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
    margin-right: 16px;
  }

  ul {
    padding-left: 20px;
    margin-top: 8px;

    li {
      margin-bottom: 6px;
      line-height: 1.5;
    }
  }
}

.diagram {
  display: flex;
  gap: 24px;
  margin-top: 16px;
  padding: 16px;
  background: lighten(@light-bg, 1%);
  border-radius: 8px;
  overflow-x: auto;

  .hash-table {
    min-width: 200px;

    .hash-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: @secondary-color;
    }

    .hash-row {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid @border-color;

      &:last-child {
        border-bottom: none;
      }
    }

    .hash-key {
      padding: 4px 8px;
      background: lighten(@accent-color, 35%);
      border-radius: 4px;
      font-weight: 500;
    }

    .hash-arrow {
      margin: 0 8px;
      color: @primary-color;
    }
  }

  .linked-list {
    display: flex;
    gap: 16px;
    align-items: center;

    .node {
      min-width: 150px;
      border: 2px solid @primary-color;
      border-radius: 8px;
      overflow: hidden;

      .node-header {
        background: @primary-color;
        color: white;
        padding: 8px 12px;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .node-content {
        padding: 12px;
        font-size: 0.9rem;
      }
    }

    .head-node,
    .tail-node {
      min-width: 100px;
      background: @light-bg;
      border: 2px dashed @border-color;

      .node-header {
        background: @light-bg;
        color: @text-color;
        font-weight: 600;
      }
    }
  }
}

.code-block {
  background: #2d3748;
  border-radius: 8px;
  padding: 18px;
  overflow-x: auto;
  color: #e2e8f0;
  font-family: 'Fira Code', monospace;
  font-size: 0.95rem;
  line-height: 1.5;

  code {
    display: block;
  }
}

.visualization-section {
  h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: @secondary-color;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid @accent-color;
  }
}

.demo-card {
  background: @card-bg;
  border-radius: 12px;
  box-shadow: @shadow;
  padding: 24px;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.cache-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.control-group {
  display: flex;
  flex-direction: column;

  label {
    font-weight: 500;
    margin-bottom: 6px;
    color: @text-color;
  }

  input {
    padding: 10px 12px;
    border: 1px solid @border-color;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;

    &:focus {
      outline: none;
      border-color: @primary-color;
      box-shadow: 0 0 0 3px fade(@primary-color, 20%);
    }
  }
}

.button-group {
  display: flex;
  gap: 12px;
  align-self: flex-end;
  justify-content: flex-end;

  @media (max-width: 768px) {
    justify-content: flex-start;
  }
}

.btn {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;

  &:hover {
    transform: translateY(-2px);
  }

  &:active {
    transform: translateY(1px);
  }
}

.put-btn {
  background: @primary-color;
  color: white;

  &:hover {
    background: darken(@primary-color, 5%);
    box-shadow: 0 4px 6px fade(@primary-color, 20%);
  }
}

.get-btn {
  background: @success-color;
  color: white;

  &:hover {
    background: darken(@success-color, 5%);
    box-shadow: 0 4px 6px fade(@success-color, 20%);
  }
}

.reset-btn {
  background: @light-bg;
  color: @text-color;
  border: 1px solid @border-color;

  &:hover {
    background: darken(@light-bg, 2%);
  }
}

.cache-status {
  display: flex;
  gap: 24px;
  margin-bottom: 24px;
  padding: 16px;
  background: lighten(@light-bg, 1%);
  border-radius: 8px;
  border: 1px solid @border-color;

  .status-item {
    display: flex;
    align-items: center;
  }

  .status-label {
    font-weight: 500;
    color: @text-color;
  }

  .status-value {
    font-weight: 600;
    margin-left: 8px;
    color: @primary-color;
  }
}

.cache-display {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  background: @light-bg;
  border-radius: 8px;
  border: 1px solid @border-color;
  overflow: hidden;
}

.cache-header {
  padding: 14px 20px;
  background: @primary-color;
  color: white;
  font-weight: 600;
}

.cache-items-wrapper {
  flex-grow: 1;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  align-content: flex-start;
  max-height: 400px;
  overflow-y: auto;
}

.cache-item {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
  border: 1px solid @border-color;
  transition: all 0.3s ease;
  animation: fadeIn 0.4s ease-out;

  &.new-item {
    border: 2px solid @success-color;
    box-shadow: 0 0 0 3px fade(@success-color, 20%);
    animation: highlight 1.5s ease;
  }

  &.accessed-item {
    border: 2px solid @accent-color;
    box-shadow: 0 0 0 3px fade(@accent-color, 20%);
    animation: highlight 1.5s ease;
  }
}

.item-header {
  display: flex;
  justify-content: space-between;
  padding: 10px 12px;
  background: fade(@primary-color, 8%);
  border-bottom: 1px solid @border-color;
}

.item-key {
  font-weight: 600;
  color: @primary-color;
}

.item-timestamp {
  font-size: 0.75rem;
  color: lighten(@text-color, 30%);
}

.item-value {
  padding: 14px 12px;
  font-size: 1.1rem;
  text-align: center;
  font-weight: 500;
}

.empty-cache {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 120px;
  color: lighten(@text-color, 40%);
  font-style: italic;
  grid-column: 1 / -1;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes highlight {
  0% {
    box-shadow: 0 0 0 0 fade(@success-color, 50%);
  }
  50% {
    box-shadow: 0 0 0 8px fade(@success-color, 0%);
  }
  100% {
    box-shadow: none;
  }
}
</style>
